<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FATE ROLL</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#07090f;--panel:#0e1118;--panel2:#131720;--border:#1e2535;
  --text:#cdd6f4;--muted:#4a5480;
  --common:#94a3b8;--uncommon:#4ade80;--rare:#38bdf8;
  --epic:#c084fc;--legendary:#fbbf24;--mythic:#fb923c;
  --divine:#f43f5e;--celestial:#e879f9;--eternal:#818cf8;--genesis:#22d3ee;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'Rajdhani',sans-serif;
  display:grid;grid-template-columns:282px 1fr;grid-template-rows:56px 1fr;height:100vh;overflow:hidden;}

/* ‚îÄ‚îÄ USERNAME SCREEN ‚îÄ‚îÄ */
#un-screen{position:fixed;inset:0;z-index:999;background:var(--bg);
  display:flex;align-items:center;justify-content:center;flex-direction:column;}
#un-screen::before{content:'';position:absolute;inset:0;pointer-events:none;
  background:radial-gradient(ellipse at 30% 40%,rgba(251,191,36,.05) 0%,transparent 55%),
    radial-gradient(ellipse at 70% 60%,rgba(244,63,94,.05) 0%,transparent 55%);}
.un-box{background:var(--panel);border:1px solid var(--border);border-radius:16px;
  padding:52px 48px;width:400px;text-align:center;position:relative;z-index:1;
  box-shadow:0 0 80px rgba(0,0,0,.7);}
.un-logo{font-family:'Orbitron',sans-serif;font-size:1.6rem;font-weight:900;letter-spacing:.22em;
  background:linear-gradient(135deg,#fbbf24,#fb923c,#f43f5e);-webkit-background-clip:text;
  -webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px;}
.un-sub{font-size:.75rem;color:var(--muted);letter-spacing:.1em;margin-bottom:36px;}
.un-label{font-size:.58rem;letter-spacing:.18em;text-transform:uppercase;color:var(--muted);text-align:left;margin-bottom:8px;}
.un-input{width:100%;background:var(--panel2);border:1px solid var(--border);border-radius:8px;
  color:var(--text);font-family:'Rajdhani',sans-serif;font-size:1.05rem;font-weight:600;
  padding:13px 16px;outline:none;margin-bottom:6px;letter-spacing:.06em;text-align:center;transition:border-color .2s;}
.un-input:focus{border-color:rgba(251,191,36,.5);}
.un-hint{font-size:.62rem;color:var(--muted);margin-bottom:18px;letter-spacing:.05em;}
.un-err{color:#f43f5e;font-size:.7rem;font-weight:600;margin-bottom:10px;display:none;}
.un-btn{width:100%;padding:14px;font-family:'Orbitron',sans-serif;font-size:.78rem;font-weight:700;
  letter-spacing:.18em;cursor:pointer;border:none;border-radius:8px;
  background:linear-gradient(135deg,#fbbf24,#f97316);color:#07090f;transition:opacity .15s,transform .1s;}
.un-btn:hover{opacity:.88;} .un-btn:active{transform:scale(.97);}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header{grid-column:1/-1;background:var(--panel);border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;padding:0 18px;height:56px;gap:10px;}
.logo{font-family:'Orbitron',sans-serif;font-size:.88rem;font-weight:900;letter-spacing:.2em;flex-shrink:0;
  background:linear-gradient(90deg,#fbbf24,#f43f5e);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.hstats{display:flex;gap:14px;align-items:center;flex-wrap:nowrap;}
.hstat{text-align:right;white-space:nowrap;}
.hstat-lbl{font-size:.5rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin-bottom:1px;}
.hstat-val{font-family:'Orbitron',sans-serif;font-size:.8rem;font-weight:700;transition:color .3s;}
.coin-pill{display:flex;align-items:center;gap:5px;background:rgba(251,191,36,.08);
  border:1px solid rgba(251,191,36,.25);border-radius:20px;padding:4px 10px;}
.coin-val{font-family:'Orbitron',sans-serif;font-size:.9rem;font-weight:700;color:#fbbf24;}
.boost-pill{display:none;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;
  background:rgba(74,222,128,.07);border:1px solid rgba(74,222,128,.28);}
.boost-pill.on{display:flex;}
.boost-txt{font-family:'Orbitron',sans-serif;font-size:.56rem;font-weight:700;color:#4ade80;white-space:nowrap;}
.boost-timer{font-size:.58rem;color:var(--muted);white-space:nowrap;}
.bg-indicator{display:none;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;
  background:rgba(192,132,252,.07);border:1px solid rgba(192,132,252,.28);}
.bg-indicator.on{display:flex;}
.bg-txt{font-family:'Orbitron',sans-serif;font-size:.55rem;font-weight:700;color:#c084fc;white-space:nowrap;animation:bgPulse 1.5s ease-in-out infinite;}
@keyframes bgPulse{0%,100%{opacity:1;}50%{opacity:.5;}}
.hdr-acts{display:flex;gap:5px;flex-shrink:0;}
.hdr-btn{padding:5px 10px;font-family:'Orbitron',sans-serif;font-size:.52rem;font-weight:700;
  letter-spacing:.08em;cursor:pointer;border:1px solid var(--border);border-radius:4px;
  background:transparent;color:var(--muted);transition:all .2s;text-transform:uppercase;white-space:nowrap;}
.hdr-btn:hover{border-color:var(--muted);color:var(--text);}
.hdr-btn.save{border-color:#4ade8050;color:#4ade80;} .hdr-btn.save:hover{background:#4ade8010;}
.hdr-btn.reset{border-color:#f43f5e50;color:#f43f5e;} .hdr-btn.reset:hover{background:#f43f5e10;}
.hdr-btn.admin{border-color:#c084fc50;color:#c084fc;} .hdr-btn.admin:hover{background:#c084fc10;}

/* ‚îÄ‚îÄ LEFT PANEL ‚îÄ‚îÄ */
.left-panel{grid-column:1;grid-row:2;background:var(--panel);border-right:1px solid var(--border);
  display:flex;flex-direction:column;overflow:hidden;}
.sec-head{padding:8px 14px 7px;font-size:.52rem;letter-spacing:.2em;text-transform:uppercase;
  color:var(--muted);border-bottom:1px solid var(--border);flex-shrink:0;
  display:flex;justify-content:space-between;align-items:center;}
.rar-table{flex-shrink:0;overflow-y:auto;max-height:240px;}
.rar-row{display:grid;grid-template-columns:78px 52px 1fr 26px;align-items:center;gap:4px;
  padding:3px 14px;border-bottom:1px solid rgba(30,37,53,.4);}
.rar-name{font-weight:700;font-size:.77rem;}
.rar-pct{font-size:.68rem;color:var(--muted);font-weight:600;text-align:right;}
.bar-bg{height:3px;background:rgba(255,255,255,.05);border-radius:2px;overflow:hidden;}
.bar-fill{height:100%;border-radius:2px;}
.rar-cnt{font-family:'Orbitron',sans-serif;font-size:.55rem;font-weight:700;text-align:right;color:var(--muted);transition:color .3s;}

/* CONTROLS */
.controls{padding:10px 14px;border-bottom:1px solid var(--border);flex-shrink:0;display:flex;flex-direction:column;gap:6px;}
.roll-btn{width:100%;padding:10px;font-family:'Orbitron',sans-serif;font-size:.7rem;font-weight:700;
  letter-spacing:.14em;cursor:pointer;border:none;border-radius:4px;
  background:linear-gradient(135deg,#fbbf24,#f97316);color:#07090f;
  transition:opacity .15s,transform .1s;text-transform:uppercase;}
.roll-btn:hover:not(:disabled){opacity:.85;} .roll-btn:active:not(:disabled){transform:scale(.97);}
.roll-btn:disabled{opacity:.3;cursor:not-allowed;}
.auto-row{display:flex;gap:5px;}
.auto-btn{flex:1;padding:8px;font-family:'Orbitron',sans-serif;font-size:.56rem;font-weight:700;
  letter-spacing:.07em;cursor:pointer;border:1px solid var(--border);border-radius:4px;
  background:transparent;color:var(--text);transition:all .2s;text-transform:uppercase;}
.auto-btn:hover{border-color:var(--muted);}
.auto-btn.active{background:#f43f5e1a;border-color:#f43f5e;color:#f43f5e;}
.speed-sel{background:var(--panel2);border:1px solid var(--border);border-radius:4px;
  color:var(--text);font-family:'Rajdhani',sans-serif;font-size:.8rem;font-weight:600;
  padding:7px 6px;cursor:pointer;outline:none;}
.turbo-btn{padding:8px 9px;font-family:'Orbitron',sans-serif;font-size:.54rem;font-weight:700;
  letter-spacing:.07em;cursor:pointer;border:1px solid var(--border);border-radius:4px;
  background:transparent;color:var(--muted);transition:all .2s;text-transform:uppercase;white-space:nowrap;}
.turbo-btn.unlocked{border-color:#e879f944;color:#e879f9;}
.turbo-btn.unlocked:hover{background:#e879f910;}
.turbo-btn.active{background:#e879f91a;border-color:#e879f9;color:#e879f9;}
.turbo-lock{font-size:.58rem;color:var(--muted);text-align:center;padding:2px 0;letter-spacing:.04em;}
.prog-wrap{height:2px;background:rgba(255,255,255,.04);overflow:hidden;opacity:0;transition:opacity .2s;flex-shrink:0;}
.prog-wrap.vis{opacity:1;}
.prog-fill{height:100%;background:linear-gradient(90deg,#fbbf24,#f43f5e);}
.bg-badge{font-family:'Orbitron',sans-serif;font-size:.5rem;color:#c084fc;
  padding:3px 14px;text-align:center;background:rgba(192,132,252,.05);border-top:1px solid rgba(192,132,252,.12);
  display:none;letter-spacing:.07em;}
.bg-badge.on{display:block;}

/* HISTORY */
.hist-wrap{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0;}
.hist-list{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.hist-item{display:grid;grid-template-columns:22px 1fr auto;align-items:center;gap:7px;
  padding:4px 14px;border-bottom:1px solid rgba(30,37,53,.3);
  opacity:0;transform:translateX(-7px);animation:slideIn .2s ease forwards;font-size:.79rem;}
@keyframes slideIn{to{opacity:1;transform:translateX(0);}}
.hi-em{text-align:center;font-size:.86rem;}
.hi-name{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.hi-tag{font-size:.58rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;white-space:nowrap;}

/* ‚îÄ‚îÄ RIGHT PANEL ‚îÄ‚îÄ */
.right-panel{grid-column:2;grid-row:2;display:flex;flex-direction:column;overflow:hidden;
  background:radial-gradient(ellipse at 50% 40%,#0d1020 0%,#07090f 70%);position:relative;}
.right-panel::before{content:'';position:absolute;inset:0;pointer-events:none;
  background-image:linear-gradient(rgba(255,255,255,.009) 1px,transparent 1px),
    linear-gradient(90deg,rgba(255,255,255,.009) 1px,transparent 1px);
  background-size:48px 48px;}

/* TABS */
.tabs{display:flex;border-bottom:1px solid var(--border);background:var(--panel);flex-shrink:0;position:relative;z-index:5;}
.tab-btn{padding:0 16px;height:42px;font-family:'Orbitron',sans-serif;font-size:.58rem;font-weight:700;
  letter-spacing:.12em;text-transform:uppercase;background:transparent;border:none;
  color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;
  transition:color .2s,border-color .2s;display:flex;align-items:center;gap:5px;white-space:nowrap;}
.tab-btn:hover{color:var(--text);}
.tab-btn.active{color:var(--text);border-bottom-color:#fbbf24;}
.tab-badge{background:var(--border);color:var(--muted);font-size:.54rem;padding:1px 5px;
  border-radius:10px;font-family:'Rajdhani',sans-serif;font-weight:700;transition:all .2s;}
.tab-btn.active .tab-badge{background:#fbbf2430;color:#fbbf24;}

/* TAB VIEWS */
.tab-view{flex:1;overflow:hidden;display:none;position:relative;z-index:1;}
.tab-view.active{display:flex;}
#view-roll{align-items:center;justify-content:center;flex-direction:column;gap:15px;}

/* ROLL */
#flash{position:absolute;inset:0;pointer-events:none;opacity:0;z-index:10;}
#toast{position:absolute;top:13px;left:50%;transform:translateX(-50%) translateY(-80px);
  background:linear-gradient(135deg,#fbbf24,#f43f5e);color:#07090f;
  font-family:'Orbitron',sans-serif;font-size:.56rem;font-weight:700;letter-spacing:.18em;
  padding:5px 13px;border-radius:20px;z-index:20;pointer-events:none;
  transition:transform .42s cubic-bezier(.34,1.56,.64,1);white-space:nowrap;}
#toast.show{transform:translateX(-50%) translateY(0);}
#coin-pop{position:absolute;top:46px;left:50%;transform:translateX(-50%) translateY(18px);
  font-family:'Orbitron',sans-serif;font-size:.76rem;font-weight:700;color:#fbbf24;
  z-index:20;pointer-events:none;opacity:0;text-shadow:0 0 8px #fbbf24;}
#coin-pop.show{animation:coinPop .85s ease forwards;}
@keyframes coinPop{0%{opacity:0;transform:translateX(-50%) translateY(18px);}
  20%{opacity:1;transform:translateX(-50%) translateY(-7px);}
  80%{opacity:1;transform:translateX(-50%) translateY(-11px);}
  100%{opacity:0;transform:translateX(-50%) translateY(-28px);}}

/* CINEMATIC */
#cinematic{position:absolute;inset:0;z-index:50;pointer-events:none;
  display:flex;align-items:center;justify-content:center;opacity:0;}
#cinematic.active{pointer-events:all;}
#cin-bg{position:absolute;inset:0;opacity:0;transition:opacity .5s;}
#cinematic.active #cin-bg{opacity:1;}
#cin-canvas{position:absolute;inset:0;pointer-events:none;}
#cin-card{position:relative;z-index:5;width:295px;border-radius:14px;overflow:hidden;
  transform:scale(0) rotateY(180deg);opacity:0;}
#cin-card.reveal{animation:cinReveal 1s cubic-bezier(.34,1.56,.64,1) .3s forwards;}
@keyframes cinReveal{0%{transform:scale(0) rotateY(180deg);opacity:0;}40%{opacity:1;}70%{transform:scale(1.08) rotateY(-4deg);}100%{transform:scale(1) rotateY(0deg);opacity:1;}}
#cin-card .card-body{padding:26px 20px 20px;gap:9px;}
#cin-card .card-icon{font-size:4.3rem;}
#cin-label{position:absolute;bottom:54px;left:50%;transform:translateX(-50%);
  font-family:'Orbitron',sans-serif;font-size:.56rem;letter-spacing:.27em;text-transform:uppercase;
  color:rgba(255,255,255,.32);opacity:0;white-space:nowrap;z-index:6;}
#cin-label.show{animation:fadeInUp .6s ease .8s forwards;}
@keyframes fadeInUp{from{opacity:0;transform:translateX(-50%) translateY(9px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}
#cin-skip{position:absolute;bottom:16px;right:18px;background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.32);
  font-family:'Orbitron',sans-serif;font-size:.5rem;letter-spacing:.12em;
  padding:4px 10px;border-radius:3px;cursor:pointer;opacity:0;z-index:20;transition:opacity .3s;}
#cin-skip.vis{opacity:1;} #cin-skip:hover{color:rgba(255,255,255,.7);}

/* CARD */
.idle-msg{font-family:'Orbitron',sans-serif;font-size:.66rem;letter-spacing:.22em;color:var(--muted);}
.card-wrap{position:relative;}
.card{width:248px;background:var(--panel2);border-radius:10px;overflow:hidden;
  position:relative;transform:scale(.2) rotateX(50deg);opacity:0;}
.card.show{animation:cardPop .48s cubic-bezier(.34,1.56,.64,1) forwards;}
@keyframes cardPop{0%{transform:scale(.2) rotateX(50deg);opacity:0;}55%{transform:scale(1.04) rotateX(-2deg);opacity:1;}100%{transform:scale(1) rotateX(0deg);opacity:1;}}
.card-top-bar{height:4px;width:100%;}
.card-body{padding:19px 17px 15px;display:flex;flex-direction:column;align-items:center;gap:6px;}
.card-icon{font-size:3.1rem;line-height:1;filter:drop-shadow(0 0 14px var(--c,#fff));animation:float 3s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-6px);}}
.card-rar{font-family:'Orbitron',sans-serif;font-size:.54rem;letter-spacing:.22em;font-weight:700;text-transform:uppercase;}
.card-name{font-family:'Orbitron',sans-serif;font-size:.9rem;font-weight:700;text-align:center;letter-spacing:.04em;line-height:1.3;}
.card-sep{width:28px;height:1px;opacity:.24;}
.card-odds{display:flex;gap:16px;text-align:center;}
.odds-col{display:flex;flex-direction:column;gap:2px;}
.odds-key{font-size:.5rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);}
.odds-val{font-family:'Orbitron',sans-serif;font-size:.78rem;font-weight:700;}
.card-ring{position:absolute;inset:0;border-radius:10px;pointer-events:none;}
.card-coin{font-family:'Orbitron',sans-serif;font-size:.66rem;font-weight:700;color:#fbbf24;
  text-align:center;opacity:0;animation:rewardFade 1.5s ease .6s forwards;}
@keyframes rewardFade{0%{opacity:0;transform:translateY(4px);}30%{opacity:1;transform:translateY(0);}80%{opacity:1;}100%{opacity:0;}}
.pcvs{position:absolute;inset:-120px;pointer-events:none;overflow:visible;z-index:3;}
.p{position:absolute;border-radius:50%;top:50%;left:50%;opacity:0;}
@keyframes pBurst{0%{opacity:1;transform:translate(-50%,-50%) rotate(var(--a)) translateX(0) scale(1);}100%{opacity:0;transform:translate(-50%,-50%) rotate(var(--a)) translateX(var(--d)) scale(0);}}
.shock{position:absolute;width:10px;height:10px;border-radius:50%;top:50%;left:50%;
  transform:translate(-50%,-50%) scale(0);opacity:0;pointer-events:none;z-index:1;}
.roll-lbl{font-family:'Orbitron',sans-serif;font-size:.64rem;letter-spacing:.17em;color:var(--muted);text-transform:uppercase;}

/* ‚îÄ‚îÄ INVENTORY ‚îÄ‚îÄ */
#view-inv{flex-direction:column;overflow:hidden;}
.inv-toolbar{display:flex;align-items:center;gap:6px;padding:9px 15px;
  border-bottom:1px solid var(--border);background:var(--panel);flex-shrink:0;flex-wrap:wrap;}
.inv-filt{padding:3px 8px;font-family:'Orbitron',sans-serif;font-size:.5rem;font-weight:700;
  letter-spacing:.08em;text-transform:uppercase;border:1px solid var(--border);border-radius:20px;
  background:transparent;color:var(--muted);cursor:pointer;transition:all .14s;white-space:nowrap;}
.inv-filt:hover{border-color:var(--muted);color:var(--text);}
.inv-filt.on{color:#07090f!important;border-color:transparent!important;}
.inv-sort{margin-left:auto;background:var(--panel2);border:1px solid var(--border);border-radius:4px;
  color:var(--text);font-family:'Rajdhani',sans-serif;font-size:.76rem;font-weight:600;
  padding:4px 6px;cursor:pointer;outline:none;}
.inv-sum{padding:5px 15px;font-size:.66rem;color:var(--muted);letter-spacing:.06em;
  border-bottom:1px solid var(--border);flex-shrink:0;display:flex;gap:9px;align-items:center;flex-wrap:wrap;}
.i-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0;display:inline-block;}
.inv-grid{flex:1;overflow-y:auto;padding:13px 15px;display:grid;
  grid-template-columns:repeat(auto-fill,minmax(104px,1fr));gap:8px;
  align-content:start;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.inv-empty{grid-column:1/-1;text-align:center;padding:44px 20px;color:var(--muted);}
.inv-empty-icon{font-size:1.9rem;margin-bottom:8px;opacity:.28;}
.inv-empty-txt{font-family:'Orbitron',sans-serif;font-size:.58rem;letter-spacing:.17em;}
.inv-item{background:var(--panel2);border-radius:7px;overflow:hidden;position:relative;cursor:pointer;
  transition:transform .14s;border:1px solid rgba(255,255,255,.04);
  animation:invPop .26s cubic-bezier(.34,1.56,.64,1) both;}
@keyframes invPop{from{opacity:0;transform:scale(.7);}to{opacity:1;transform:scale(1);}}
.inv-item:hover{transform:translateY(-3px) scale(1.03);}
.inv-item-bar{height:3px;width:100%;}
.inv-item-body{padding:8px 6px 7px;display:flex;flex-direction:column;align-items:center;gap:4px;text-align:center;}
.inv-em{font-size:1.75rem;line-height:1;}
.inv-iname{font-size:.64rem;font-weight:700;line-height:1.2;color:var(--text);}
.inv-itar{font-family:'Orbitron',sans-serif;font-size:.44rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;}
.inv-cnt{position:absolute;top:4px;right:4px;background:rgba(0,0,0,.6);
  border:1px solid rgba(255,255,255,.1);border-radius:9px;font-family:'Orbitron',sans-serif;
  font-size:.52rem;font-weight:700;padding:1px 4px;color:var(--text);min-width:18px;text-align:center;}
.inv-new{position:absolute;top:4px;left:4px;background:linear-gradient(135deg,#fbbf24,#f43f5e);
  color:#07090f;font-family:'Orbitron',sans-serif;font-size:.42rem;font-weight:700;
  padding:1px 4px;border-radius:3px;animation:newPulse 1s ease-in-out 3;}
@keyframes newPulse{0%,100%{opacity:1;}50%{opacity:.4;}}
.det-overlay{display:none;position:absolute;inset:0;background:rgba(7,9,15,.9);z-index:20;
  align-items:center;justify-content:center;backdrop-filter:blur(4px);}
.det-overlay.open{display:flex;}
.det-card{background:var(--panel2);border-radius:12px;overflow:hidden;width:262px;position:relative;
  animation:invPop .26s cubic-bezier(.34,1.56,.64,1) both;}
.det-bar{height:5px;} .det-body{padding:22px 20px 18px;display:flex;flex-direction:column;align-items:center;gap:8px;text-align:center;}
.det-icon{font-size:3.3rem;line-height:1;} .det-rar{font-family:'Orbitron',sans-serif;font-size:.56rem;letter-spacing:.16em;font-weight:700;text-transform:uppercase;}
.det-name{font-family:'Orbitron',sans-serif;font-size:.92rem;font-weight:700;}
.det-sep{width:28px;height:1px;opacity:.23;}
.det-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;width:100%;}
.det-stat{display:flex;flex-direction:column;gap:2px;align-items:center;}
.det-sk{font-size:.48rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);}
.det-sv{font-family:'Orbitron',sans-serif;font-size:.8rem;font-weight:700;}
.det-close{position:absolute;top:7px;right:8px;background:transparent;border:none;color:var(--muted);font-size:.95rem;cursor:pointer;transition:color .2s;}
.det-close:hover{color:var(--text);} .det-ring{position:absolute;inset:0;border-radius:12px;pointer-events:none;}

/* ‚îÄ‚îÄ SHOP ‚îÄ‚îÄ */
#view-shop{flex-direction:column;overflow:hidden;}
.shop-hdr{padding:12px 18px;border-bottom:1px solid var(--border);background:var(--panel);
  flex-shrink:0;display:flex;align-items:center;justify-content:space-between;}
.shop-title-grp{display:flex;flex-direction:column;gap:2px;}
.shop-title{font-family:'Orbitron',sans-serif;font-size:.68rem;font-weight:700;letter-spacing:.13em;}
.shop-sub{font-size:.7rem;color:var(--muted);}
.shop-bal{display:flex;align-items:center;gap:6px;font-family:'Orbitron',sans-serif;font-size:.78rem;font-weight:700;color:#fbbf24;}
.shop-body{flex:1;overflow-y:auto;padding:16px;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.shop-section{margin-bottom:22px;}
.shop-sec-title{font-family:'Orbitron',sans-serif;font-size:.6rem;letter-spacing:.2em;text-transform:uppercase;
  color:var(--muted);padding:0 0 10px;border-bottom:1px solid var(--border);margin-bottom:12px;
  display:flex;align-items:center;gap:8px;}
.boost-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;}
.boost-card{background:var(--panel2);border:1px solid var(--border);border-radius:10px;
  overflow:hidden;display:flex;flex-direction:column;transition:border-color .2s,transform .15s;}
.boost-card:hover{transform:translateY(-2px);}
.boost-card.active-boost{border-color:#4ade8066;background:rgba(74,222,128,.03);}
.boost-card.cant-afford{opacity:.55;}
.boost-top{padding:16px 14px 10px;display:flex;flex-direction:column;align-items:center;gap:7px;flex:1;}
.boost-icon{font-size:2rem;line-height:1;}
.boost-name{font-family:'Orbitron',sans-serif;font-size:.68rem;font-weight:700;text-align:center;letter-spacing:.04em;}
.boost-desc{font-size:.7rem;color:var(--muted);text-align:center;line-height:1.4;}
.boost-duration{font-size:.62rem;font-weight:700;color:var(--text);text-align:center;letter-spacing:.04em;}
.boost-timer-disp{font-family:'Orbitron',sans-serif;font-size:.62rem;font-weight:700;color:#4ade80;text-align:center;}
.boost-effect{font-size:.64rem;font-weight:700;text-align:center;}
.boost-bottom{padding:8px 13px 12px;border-top:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;gap:8px;}
.boost-price{display:flex;align-items:center;gap:4px;font-family:'Orbitron',sans-serif;font-size:.72rem;font-weight:700;color:#fbbf24;}
.boost-btn{padding:5px 12px;font-family:'Orbitron',sans-serif;font-size:.58rem;font-weight:700;
  letter-spacing:.08em;cursor:pointer;border:none;border-radius:4px;
  background:linear-gradient(135deg,#fbbf24,#f97316);color:#07090f;transition:opacity .15s;white-space:nowrap;}
.boost-btn:hover{opacity:.84;} .boost-btn:disabled{opacity:.32;cursor:not-allowed;}
.boost-btn.active-btn{background:rgba(74,222,128,.14);color:#4ade80;border:1px solid #4ade8044;cursor:default;}

/* ‚îÄ‚îÄ LEADERBOARD ‚îÄ‚îÄ */
#view-board{flex-direction:column;overflow:hidden;}
.board-hdr{padding:11px 18px 9px;border-bottom:1px solid var(--border);background:var(--panel);
  flex-shrink:0;display:flex;align-items:center;justify-content:space-between;}
.board-title{font-family:'Orbitron',sans-serif;font-size:.74rem;font-weight:700;letter-spacing:.14em;}
.board-sub{font-size:.66rem;color:var(--muted);}
.board-refresh{padding:5px 10px;font-family:'Orbitron',sans-serif;font-size:.52rem;font-weight:700;
  letter-spacing:.08em;cursor:pointer;border:1px solid var(--border);border-radius:4px;
  background:transparent;color:var(--muted);transition:all .2s;}
.board-refresh:hover{color:var(--text);border-color:var(--muted);}
.board-body{flex:1;overflow-y:auto;padding:13px 18px;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.board-col-head{display:grid;grid-template-columns:36px 1fr 96px 76px 90px;gap:10px;
  padding:3px 13px 7px;font-size:.5rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);}
.board-entry{display:grid;grid-template-columns:36px 1fr 96px 76px 90px;align-items:center;gap:10px;
  padding:8px 13px;border-radius:5px;margin-bottom:5px;background:var(--panel2);
  border:1px solid var(--border);}
.board-entry.me{border-color:#fbbf2444;background:rgba(251,191,36,.03);}
.board-entry.top1{border-color:#fbbf2477;} .board-entry.top2{border-color:#94a3b855;} .board-entry.top3{border-color:#fb923c55;}
.board-rank{font-family:'Orbitron',sans-serif;font-size:.8rem;font-weight:700;text-align:center;}
.board-name{font-weight:700;font-size:.86rem;}
.you-tag{font-size:.5rem;color:#fbbf24;font-family:'Orbitron',sans-serif;margin-left:5px;letter-spacing:.08em;}
.board-coins{font-family:'Orbitron',sans-serif;font-size:.74rem;font-weight:700;color:#fbbf24;text-align:right;}
.board-rolls{font-family:'Orbitron',sans-serif;font-size:.7rem;font-weight:700;color:var(--muted);text-align:right;}
.board-best{font-size:.62rem;font-weight:700;text-align:right;}

/* ‚îÄ‚îÄ EDITOR VIEW ‚îÄ‚îÄ */
.editor-wrap{flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:24px;}
.editor-section{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:20px;}
.editor-title{font-family:'Orbitron',sans-serif;font-size:1.1rem;font-weight:700;margin-bottom:16px;letter-spacing:.05em;color:#fbbf24;}
.editor-subtitle{font-size:.75rem;color:var(--muted);margin-bottom:16px;line-height:1.5;}
.editor-list{display:flex;flex-direction:column;gap:10px;margin-bottom:16px;}
.editor-rarity-item{background:var(--panel2);border:1px solid var(--border);border-radius:6px;padding:12px;display:grid;grid-template-columns:auto 1fr auto auto auto;gap:12px;align-items:center;}
.editor-rarity-color{width:32px;height:32px;border-radius:4px;cursor:pointer;border:2px solid var(--border);}
.editor-rarity-info{display:flex;flex-direction:column;gap:4px;}
.editor-rarity-name{font-weight:700;font-size:.85rem;}
.editor-rarity-chance{font-size:.7rem;color:var(--muted);}
.editor-btn{padding:6px 12px;font-family:'Orbitron',sans-serif;font-size:.6rem;font-weight:700;letter-spacing:.08em;cursor:pointer;border:1px solid var(--border);border-radius:4px;background:transparent;color:var(--text);transition:all .2s;text-transform:uppercase;}
.editor-btn:hover{border-color:var(--muted);background:rgba(255,255,255,.05);}
.editor-btn.primary{background:#fbbf2420;border-color:#fbbf2450;color:#fbbf24;}
.editor-btn.primary:hover{background:#fbbf2430;}
.editor-btn.danger{border-color:#f43f5e50;color:#f43f5e;}
.editor-btn.danger:hover{background:#f43f5e10;}
.editor-input{background:var(--panel2);border:1px solid var(--border);border-radius:4px;padding:8px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:.82rem;outline:none;width:100%;}
.editor-input:focus{border-color:var(--muted);}
.editor-form{display:flex;flex-direction:column;gap:12px;margin-top:16px;padding-top:16px;border-top:1px solid var(--border);}
.editor-form-group{display:flex;flex-direction:column;gap:6px;}
.editor-label{font-size:.65rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);font-weight:700;}
.editor-item-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:16px;}
.editor-item-card{background:var(--panel2);border:1px solid var(--border);border-radius:6px;padding:12px;display:flex;flex-direction:column;gap:8px;}
.editor-item-preview{display:flex;align-items:center;gap:10px;}
.editor-item-emoji{font-size:2rem;width:48px;height:48px;display:flex;align-items:center;justify-content:center;border-radius:4px;background:var(--panel);}
.editor-item-emoji img{width:100%;height:100%;object-fit:cover;border-radius:4px;}
.editor-item-details{flex:1;}
.editor-item-name{font-weight:700;font-size:.82rem;margin-bottom:2px;}
.editor-item-rarity{font-size:.62rem;text-transform:uppercase;letter-spacing:.08em;}
.editor-item-actions{display:flex;gap:6px;}
.editor-file-input{display:none;}
.editor-upload-btn{padding:8px 12px;background:var(--panel);border:1px dashed var(--border);border-radius:4px;cursor:pointer;text-align:center;font-size:.7rem;color:var(--muted);transition:all .2s;}
.editor-upload-btn:hover{border-color:var(--muted);color:var(--text);}
.editor-color-preview{width:24px;height:24px;border-radius:4px;border:1px solid var(--border);}

.board-loading{text-align:center;padding:36px;color:var(--muted);font-family:'Orbitron',sans-serif;font-size:.6rem;letter-spacing:.17em;}
.board-status{font-size:.62rem;color:var(--muted);text-align:center;padding:6px;letter-spacing:.06em;display:flex;align-items:center;justify-content:center;gap:6px;}
.board-dot{width:6px;height:6px;border-radius:50%;animation:blink 1.5s ease-in-out infinite;}
@keyframes blink{0%,100%{opacity:.3;}50%{opacity:1;}}

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.modal-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:200;
  align-items:center;justify-content:center;backdrop-filter:blur(5px);}
.modal-ov.open{display:flex;}
.modal-box{background:var(--panel);border:1px solid var(--border);border-radius:12px;
  width:420px;max-width:92vw;max-height:82vh;overflow-y:auto;
  animation:invPop .28s cubic-bezier(.34,1.56,.64,1) both;}
.modal-hdr{padding:13px 17px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;background:var(--panel);z-index:2;}
.modal-ttl{font-family:'Orbitron',sans-serif;font-size:.7rem;font-weight:700;letter-spacing:.13em;}
.modal-x{background:transparent;border:none;color:var(--muted);font-size:.95rem;cursor:pointer;transition:color .2s;}
.modal-x:hover{color:var(--text);}
.modal-body{padding:17px;}
.m-inp{width:100%;background:var(--panel2);border:1px solid var(--border);border-radius:6px;
  color:var(--text);font-family:'Rajdhani',sans-serif;font-size:.88rem;font-weight:600;
  padding:9px 12px;outline:none;margin-bottom:9px;letter-spacing:.06em;}
.m-inp:focus{border-color:var(--muted);}
.m-btn{width:100%;padding:9px;font-family:'Orbitron',sans-serif;font-size:.66rem;font-weight:700;
  letter-spacing:.12em;cursor:pointer;border:none;border-radius:6px;
  background:linear-gradient(135deg,#fbbf24,#f97316);color:#07090f;margin-bottom:7px;}
.m-btn.danger{background:linear-gradient(135deg,#f43f5e,#dc2626);}
.m-btn.sec{background:transparent;border:1px solid var(--border);color:var(--muted);}
.m-btn.sec:hover{border-color:var(--muted);color:var(--text);}
.m-err{color:#f43f5e;font-size:.68rem;font-weight:600;margin-bottom:8px;display:none;}
.m-lbl{font-size:.54rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin-bottom:5px;}
.m-row{display:flex;gap:7px;margin-bottom:7px;}
.adm-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:11px;}
.adm-stat{background:var(--panel2);border:1px solid var(--border);border-radius:6px;padding:9px 11px;}
.adm-sl{font-size:.5rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:3px;}
.adm-sv{font-family:'Orbitron',sans-serif;font-size:.92rem;font-weight:700;}
.adm-sec{font-family:'Orbitron',sans-serif;font-size:.54rem;letter-spacing:.15em;text-transform:uppercase;color:var(--muted);margin:11px 0 6px;}
.adm-row{display:flex;align-items:center;gap:6px;padding:5px 8px;background:var(--panel2);border-radius:4px;margin-bottom:4px;font-size:.76rem;}
.adm-name{flex:1;font-weight:600;}
.adm-coins{color:#fbbf24;font-family:'Orbitron',sans-serif;font-size:.66rem;font-weight:700;min-width:54px;text-align:right;}
.adm-del{background:transparent;border:1px solid #f43f5e44;border-radius:3px;color:#f43f5e;font-size:.54rem;padding:2px 5px;cursor:pointer;font-family:'Orbitron',sans-serif;}

/* NOTIF */
.notif{position:fixed;bottom:18px;right:18px;z-index:300;padding:8px 15px;border-radius:5px;
  font-family:'Orbitron',sans-serif;font-size:.58rem;font-weight:700;letter-spacing:.1em;
  transform:translateY(70px);opacity:0;transition:all .32s cubic-bezier(.34,1.56,.64,1);}
.notif.show{transform:translateY(0);opacity:1;}
.notif.ok{background:#4ade8020;border:1px solid #4ade8060;color:#4ade80;}
.notif.err{background:#f43f5e20;border:1px solid #f43f5e60;color:#f43f5e;}
.notif.info{background:#fbbf2420;border:1px solid #fbbf2460;color:#fbbf24;}
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

</head>
<body>

<!-- USERNAME SCREEN -->
<div id="un-screen">
  <div class="un-box">
    <div class="un-logo">‚¨° FATE ROLL</div>
    <div class="un-sub">Test your luck against the cosmos</div>
    
    <!-- Sign In Step (shown first) -->
    <div id="signInStep">
      <div class="un-label">Sign in with Google</div>
      <div style="font-size:.7rem;color:var(--muted);margin-bottom:16px;line-height:1.5">
        Required to save your progress and compete on the leaderboard
      </div>
      <button class="un-btn" onclick="startSignIn()" style="display:flex;align-items:center;justify-content:center;gap:10px">
        <svg width="18" height="18" viewBox="0 0 18 18" style="fill:currentColor">
          <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
          <path d="M9.003 18c2.43 0 4.467-.806 5.956-2.18L12.05 13.56c-.806.54-1.836.86-3.047.86-2.344 0-4.328-1.584-5.036-3.711H.96v2.332C2.44 15.983 5.485 18 9.003 18z" fill="#34A853"/>
          <path d="M3.964 10.71c-.18-.54-.282-1.117-.282-1.71s.102-1.17.282-1.71V4.958H.957C.347 6.173 0 7.548 0 9s.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/>
          <path d="M9.003 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.464.891 11.426 0 9.003 0 5.485 0 2.44 2.017.96 4.958L3.966 7.29c.708-2.127 2.692-3.71 5.036-3.71z" fill="#EA4335"/>
        </svg>
        SIGN IN WITH GOOGLE
      </button>
      <div style="font-size:.62rem;color:var(--muted);margin-top:12px">
        New here? No account needed ‚Äî just sign in to start!
      </div>
    </div>
    
    <!-- Username Step (shown after sign in) -->
    <div id="usernameStep" style="display:none">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;padding:10px;background:var(--panel2);border-radius:8px;border:1px solid var(--border)">
        <span style="font-size:.7rem;color:var(--muted)">Signed in as:</span>
        <span id="signedInEmail" style="font-size:.8rem;color:#4ade80;font-weight:700;flex:1"></span>
      </div>
      
      <div class="un-label">Choose your display name</div>
      <input class="un-input" id="unInput" placeholder="Username..." maxlength="20"
        onkeydown="if(event.key==='Enter')startGame()"/>
      <div class="un-hint">3‚Äì20 characters ¬∑ shown on leaderboard</div>
      <div class="un-err" id="unErr">Name must be 3‚Äì20 characters</div>
      <button class="un-btn" onclick="startGame()">‚ñ∂ ENTER THE VOID</button>
    </div>
  </div>
</div>

<!-- HEADER -->
<header>
  <div class="logo">‚¨° FATE ROLL</div>
  <div class="hstats">
    <div class="hstat"><div class="hstat-lbl">Player</div><div class="hstat-val" id="hs-name" style="color:#fbbf24">‚Äî</div></div>
    <div class="hstat"><div class="hstat-lbl">Rolls</div><div class="hstat-val" id="hs-rolls">0</div></div>
    <div class="hstat"><div class="hstat-lbl">Best</div><div class="hstat-val" id="hs-best" style="color:var(--muted)">‚Äî</div></div>
    <div class="coin-pill">ü™ô<span class="coin-val" id="hs-coins">0</span></div>
    <div class="boost-pill" id="boostPill">
      <span class="boost-txt" id="boostTxt">LUCK</span>
      <span class="boost-timer" id="boostTimer"></span>
    </div>
    <div class="bg-indicator" id="bgIndicator">
      <span class="bg-txt">‚ü≥ ROLLING</span>
    </div>
  </div>
  <div class="hdr-acts">
    <button class="hdr-btn save" onclick="saveGame()">üíæ Save</button>
    <button id="signInBtn" class="hdr-btn" onclick="signInWithGoogle()" style="border-color:#4ade8050;color:#4ade80">üîê Sign In</button>
    <button id="adminBtn" class="hdr-btn admin" onclick="openAdmin()" style="display:none">‚öô Admin</button>
    <button class="hdr-btn reset" onclick="openModal('resetMod')">‚Ü∫ Reset</button>
  </div>
</header>

<!-- LEFT PANEL -->
<div class="left-panel">
  <div class="sec-head">Rarity &amp; Odds</div>
  <div class="rar-table" id="rarTable"></div>
  <div class="controls">
    <button class="roll-btn" id="rollBtn" onclick="doRoll()">‚ñ∂ ROLL <span style="opacity:.4;font-size:.75em">[SPC]</span></button>
    <div class="auto-row">
      <button class="auto-btn" id="autoBtn" onclick="toggleAuto()">‚ü≥ AUTO <span style="opacity:.4;font-size:.75em">[A]</span></button>
      <select class="speed-sel" id="speedSel">
        <option value="2000">Slow</option>
        <option value="1000" selected>Normal</option>
        <option value="480">Fast</option>
        <option value="80" id="turboOption" disabled>‚ö° Turbo (üîí 500 rolls)</option>
      </select>
    </div>
  </div>
  <div class="prog-wrap" id="progWrap"><div class="prog-fill" id="progFill"></div></div>
  <div class="bg-badge" id="bgBadge">‚ü≥ AUTO ROLLING IN BACKGROUND</div>
  <div class="hist-wrap">
    <div class="sec-head"><span>Recent Rolls</span><span style="cursor:pointer;font-size:.55rem" onclick="document.getElementById('histList').innerHTML=''">CLEAR</span></div>
    <div class="hist-list" id="histList"></div>
  </div>
</div>

<!-- RIGHT PANEL -->
<div class="right-panel">
  <div class="tabs">
    <button class="tab-btn active" id="tab-roll" onclick="switchTab('roll')">üé≤ Roll</button>
    <button class="tab-btn" id="tab-inv"  onclick="switchTab('inv')">üéí Inv <span class="tab-badge" id="invBadge">0</span></button>
    <button class="tab-btn" id="tab-shop" onclick="switchTab('shop')">üõí Shop</button>
    <button class="tab-btn" id="tab-board" onclick="switchTab('board')">üèÜ Board</button>
    <button class="tab-btn" id="tab-editor" onclick="switchTab('editor')" style="display:none;">‚öôÔ∏è Editor</button>
  </div>

  <!-- ROLL VIEW -->
  <div class="tab-view active" id="view-roll">
    <div id="flash"></div>
    <div id="toast">‚ú¶ NEW BEST ‚ú¶</div>
    <div id="coin-pop"></div>
    <div class="idle-msg" id="idleMsg">PRESS ROLL TO BEGIN</div>
    <div class="card-wrap" id="cardWrap" style="display:none">
      <div class="pcvs" id="pcvs"></div>
      <div class="shock" id="shock"></div>
      <div class="card" id="card"></div>
    </div>
    <div class="roll-lbl" id="rollLbl" style="visibility:hidden">ROLL #0</div>
    <div id="cinematic">
      <div id="cin-bg"></div>
      <canvas id="cin-canvas"></canvas>
      <div id="cin-card"></div>
      <div id="cin-label"></div>
      <button id="cin-skip" onclick="skipCin()">SKIP [ESC]</button>
    </div>
  </div>

  <!-- INVENTORY VIEW -->
  <div class="tab-view" id="view-inv">
    <div class="inv-toolbar" id="invToolbar">
      <button class="inv-filt on" id="filt-all" onclick="setFilter('all')"
        style="background:var(--muted);border-color:var(--muted);color:#07090f">All</button>
      <select class="inv-sort" id="invSort" onchange="renderInv()">
        <option value="rarity-desc">Rarest first</option>
        <option value="rarity-asc">Common first</option>
        <option value="count-desc">Most owned</option>
        <option value="az">A ‚Üí Z</option>
      </select>
    </div>
    <div class="inv-sum" id="invSum"><span style="color:var(--text);font-weight:700">0 items</span></div>
    <div class="inv-grid" id="invGrid">
      <div class="inv-empty"><div class="inv-empty-icon">üéí</div><div class="inv-empty-txt">No items yet</div></div>
    </div>
    <div class="det-overlay" id="detOv" onclick="if(event.target===this)this.classList.remove('open')">
      <div class="det-card" id="detCard"></div>
    </div>
  </div>

  <!-- SHOP VIEW -->
  <div class="tab-view" id="view-shop">
    <div class="shop-hdr">
      <div class="shop-title-grp">
        <div class="shop-title">FATE SHOP</div>
        <div class="shop-sub">Purchase luck boosts to tip the scales</div>
      </div>
      <div class="shop-bal">ü™ô <span id="shopCoins">0</span></div>
    </div>
    <div class="shop-body" id="shopBody"></div>
  </div>

  <!-- LEADERBOARD VIEW -->
  <div class="tab-view" id="view-board">
    <div class="board-hdr">
      <div><div class="board-title">LEADERBOARD</div><div class="board-sub">Global rankings ‚Äî updates live</div></div>
      <button class="board-refresh" onclick="loadBoard(true)">‚Ü∫ Refresh</button>
    </div>
    <div class="board-body" id="boardBody">
      <div class="board-status" id="boardStatus">
        <span class="board-dot" style="background:#fbbf24"></span>
        <span>Waiting for game to start...</span>
      </div>
      <div class="board-col-head"><span>#</span><span>Player</span>
        <span style="text-align:right">Coins</span>
        <span style="text-align:right">Rolls</span>
        <span style="text-align:right">Best Pull</span>
      </div>
      <div id="boardList"></div>
    </div>
  </div>

  <!-- EDITOR VIEW -->
  <div class="tab-view" id="view-editor">
    <div class="editor-wrap">
      <!-- RARITIES SECTION -->
      <div class="editor-section">
        <div class="editor-title">‚≠ê Custom Rarities</div>
        <div class="editor-subtitle">Create and manage custom rarities. Changes apply immediately to the roll system.</div>
        
        <div class="editor-list" id="editorRarityList"></div>
        
        <div class="editor-form" id="rarityForm">
          <div class="editor-form-group">
            <label class="editor-label">Rarity Name</label>
            <input type="text" class="editor-input" id="rarityName" placeholder="e.g., Mystical, Ascended, etc.">
          </div>
          <div class="editor-form-group">
            <label class="editor-label">Color (Hex)</label>
            <div style="display:flex;gap:8px;align-items:center;">
              <input type="text" class="editor-input" id="rarityColor" placeholder="#ff00ff" style="flex:1;">
              <input type="color" id="rarityColorPicker" style="width:48px;height:36px;border:none;background:transparent;cursor:pointer;">
            </div>
          </div>
          <div class="editor-form-group">
            <label class="editor-label">Drop Chance (%)</label>
            <input type="number" class="editor-input" id="rarityChance" placeholder="1.5" step="0.01" min="0.001" max="100">
          </div>
          <div class="editor-form-group">
            <label class="editor-label">Emoji/Icon</label>
            <input type="text" class="editor-input" id="rarityEmoji" placeholder="‚ú® or any emoji">
          </div>
          <button class="editor-btn primary" onclick="saveRarity()" style="width:100%;">‚ûï CREATE RARITY</button>
        </div>
      </div>

      <!-- ITEMS SECTION -->
      <div class="editor-section">
        <div class="editor-title">üéÅ Custom Items</div>
        <div class="editor-subtitle">Add custom items to any rarity. Use emojis or upload your own images.</div>
        
        <div class="editor-form-group" style="margin-bottom:16px;">
          <label class="editor-label">Select Rarity</label>
          <select class="editor-input" id="itemRaritySelect" onchange="renderEditorItems()">
            <option value="">Choose a rarity...</option>
          </select>
        </div>

        <div class="editor-item-list" id="editorItemList"></div>
        
        <div class="editor-form" id="itemForm">
          <div class="editor-form-group">
            <label class="editor-label">Item Name</label>
            <input type="text" class="editor-input" id="itemName" placeholder="e.g., Cosmic Blade, Ancient Scroll">
          </div>
          <div class="editor-form-group">
            <label class="editor-label">Emoji or Image</label>
            <div style="display:flex;gap:8px;">
              <input type="text" class="editor-input" id="itemEmoji" placeholder="üó°Ô∏è or any emoji" style="flex:1;">
              <label for="itemImageUpload" class="editor-upload-btn" style="flex:1;">üìÅ Upload Image</label>
              <input type="file" id="itemImageUpload" class="editor-file-input" accept="image/*" onchange="handleImageUpload(event)">
            </div>
            <div id="imagePreview" style="margin-top:8px;display:none;">
              <img id="imagePreviewImg" style="width:64px;height:64px;object-fit:cover;border-radius:4px;border:1px solid var(--border);">
            </div>
          </div>
          <button class="editor-btn primary" onclick="saveItem()" style="width:100%;">‚ûï CREATE ITEM</button>
        </div>
      </div>

      <!-- ACTIONS SECTION -->
      <div class="editor-section">
        <div class="editor-title">üîß Actions</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="editor-btn" onclick="exportCustomData()">üíæ Export Custom Data</button>
          <button class="editor-btn" onclick="importCustomData()">üì• Import Custom Data</button>
          <button class="editor-btn danger" onclick="resetCustomData()">üóëÔ∏è Reset All Custom Data</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODALS -->
<div class="modal-ov" id="resetMod">
  <div class="modal-box">
    <div class="modal-hdr"><div class="modal-ttl">RESET PROGRESS</div><button class="modal-x" onclick="closeModal('resetMod')">‚úï</button></div>
    <div class="modal-body">
      <p style="color:var(--muted);font-size:.8rem;margin-bottom:16px;line-height:1.6">This permanently erases <strong style="color:var(--text)">all rolls, coins, inventory and upgrades</strong>. Cannot be undone.</p>
      <button class="m-btn danger" onclick="confirmReset()">‚ö† DELETE EVERYTHING</button>
      <button class="m-btn sec" onclick="closeModal('resetMod')">Cancel</button>
    </div>
  </div>
</div>

<div class="modal-ov" id="adminMod">
  <div class="modal-box" style="width:480px">
    <div class="modal-hdr">
      <div class="modal-ttl">‚öô ADMIN PANEL</div>
      <button class="modal-x" onclick="closeModal('adminMod')">‚úï</button>
    </div>
    <div class="modal-body">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;padding:8px;background:var(--panel2);border-radius:6px;border:1px solid var(--border)">
        <span style="font-size:.7rem;color:var(--muted)">Signed in as:</span>
        <span id="adminEmail" style="font-size:.75rem;color:#4ade80;font-weight:700;flex:1"></span>
        <button class="m-btn sec" style="padding:4px 10px;margin:0;font-size:.6rem" onclick="signOutAdmin()">Sign Out</button>
      </div>
      <div id="adminBody"></div>
    </div>
  </div>
</div>

<div class="modal-ov" id="rarityCreatorMod">
  <div class="modal-box" style="width:520px">
    <div class="modal-hdr">
      <div class="modal-ttl">‚ú® CREATE CUSTOM RARITY</div>
      <button class="modal-x" onclick="closeModal('rarityCreatorMod')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="m-lbl">Rarity Name</div>
      <input class="m-inp" id="rarName" placeholder="e.g. Mythical, Ultimate, Supreme..." maxlength="20"/>
      
      <div class="m-lbl">Icon / Emoji</div>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <input class="m-inp" id="rarIcon" placeholder="Paste emoji or text..." maxlength="5" style="flex:1;margin-bottom:0"/>
        <label style="cursor:pointer">
          <input type="file" id="rarIconFile" accept="image/*" style="display:none" onchange="handleRarityImage(this)"/>
          <button class="m-btn sec" style="width:auto;padding:8px 13px;margin:0" onclick="document.getElementById('rarIconFile').click();event.preventDefault()">üìÅ Upload</button>
        </label>
      </div>
      <div id="rarIconPreview" style="display:none;text-align:center;padding:12px;background:var(--panel2);border-radius:6px;margin-bottom:12px">
        <img id="rarIconImg" style="max-width:80px;max-height:80px;border-radius:4px"/>
      </div>
      
      <div class="m-lbl">Color (Hex)</div>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <input class="m-inp" id="rarColor" placeholder="#ff6b9d" maxlength="7" style="flex:1;margin-bottom:0"/>
        <input type="color" id="rarColorPicker" style="width:50px;height:38px;border:1px solid var(--border);border-radius:6px;background:var(--panel2);cursor:pointer" onchange="document.getElementById('rarColor').value=this.value"/>
      </div>
      
      <div class="m-lbl">Drop Rate (%)</div>
      <input class="m-inp" id="rarPct" type="number" step="0.001" min="0.001" max="100" placeholder="e.g. 0.05 for 0.05%"/>
      
      <div class="m-lbl">Coin Reward</div>
      <input class="m-inp" id="rarCoins" type="number" min="1" placeholder="e.g. 5000"/>
      
      <div style="padding:10px;background:var(--panel2);border-radius:6px;border:1px solid var(--border);margin-bottom:12px">
        <div style="font-size:.65rem;color:var(--muted);margin-bottom:6px">PREVIEW:</div>
        <div style="display:flex;align-items:center;gap:10px">
          <span id="rarPreviewIcon" style="font-size:2rem">‚ú®</span>
          <div>
            <div id="rarPreviewName" style="font-weight:700;font-size:.9rem;color:#c084fc">NEW RARITY</div>
            <div style="font-size:.65rem;color:var(--muted)">
              <span id="rarPreviewPct">0.05%</span> ¬∑ 
              <span id="rarPreviewCoins">ü™ô 5000</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="m-err" id="rarErr" style="display:none"></div>
      <button class="m-btn" onclick="saveCustomRarity()">CREATE RARITY</button>
      <button class="m-btn sec" onclick="closeModal('rarityCreatorMod')">CANCEL</button>
    </div>
  </div>
</div>

<div class="notif" id="notif"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA ‚Äî RARITIES (10 tiers, each has cumulative threshold)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const RARITIES = [
  // Ultra-ultra endgame ‚Äî nearly impossible
  {key:'primordial', label:'Primordial', pct:0.0008, color:'#06b6d4', np:100, fx:15},
  {key:'genesis',    label:'Genesis',    pct:0.0012, color:'#22d3ee', np:85,  fx:13},
  {key:'cosmic',     label:'Cosmic',     pct:0.003,  color:'#a78bfa', np:80,  fx:12},
  {key:'eternal',    label:'Eternal',    pct:0.007,  color:'#818cf8', np:75,  fx:11},
  {key:'celestial',  label:'Celestial',  pct:0.012,  color:'#e879f9', np:70,  fx:10},
  {key:'transcendent', label:'Transcendent', pct:0.025, color:'#ec4899', np:67, fx:10},
  {key:'divine',     label:'Divine',     pct:0.05,   color:'#f43f5e', np:65,  fx:9 },
  // Hard mid-game
  {key:'ancient',    label:'Ancient',    pct:0.12,   color:'#f59e0b', np:60,  fx:8 },
  {key:'mythic',     label:'Mythic',     pct:0.30,   color:'#fb923c', np:55,  fx:7 },
  {key:'exalted',    label:'Exalted',    pct:1.0,    color:'#eab308', np:35,  fx:4 },
  // Standard
  {key:'legendary',  label:'Legendary',  pct:3.5,    color:'#fbbf24', np:28,  fx:3 },
  {key:'epic',       label:'Epic',       pct:8.0,    color:'#c084fc', np:20,  fx:2 },
  {key:'rare',       label:'Rare',       pct:15.0,   color:'#38bdf8', np:14,  fx:1 },
  {key:'uncommon',   label:'Uncommon',   pct:30.0,   color:'#4ade80', np:7,   fx:0 },
  {key:'common',     label:'Common',     pct:41.9828, color:'#94a3b8', np:4,   fx:0 },
];
(()=>{let c=0; RARITIES.forEach(r=>{c+=r.pct/100; r.threshold=Math.min(1,c);}); RARITIES[RARITIES.length-1].threshold=1.0;})();

const ORDER = ['common','uncommon','rare','epic','legendary','exalted','mythic','ancient','divine','transcendent','celestial','eternal','cosmic','genesis','primordial'];

const COIN_REWARDS = {
  primordial:150000, genesis:75000, cosmic:35000, eternal:18000, celestial:9000, 
  transcendent:5000, divine:2500, ancient:800, mythic:400, exalted:150, 
  legendary:80, epic:25, rare:8, uncommon:3, common:1
};

// ‚îÄ‚îÄ ITEMS ‚Äî 3+ per all tiers except eternal (3) and celestial (3) ‚îÄ‚îÄ
const ITEMS = {
  primordial:[['üåÄ','Origin Vortex'],['üí†','Universe Seed'],['‚öõÔ∏è','First Atom'],['üåä','Primordial Tide']],
  genesis:   [['üåä','The Primeval Wave'],['‚öõÔ∏è','Quark Singularity'],['ü™ê','Titan Core'],
               ['üåê','World Engine'],['üí•','Big Bang Echo'],['‚ö°','Void Lightning'],['üß¨','Genesis Strand']],
  cosmic:    [['üåå','Cosmic Nexus'],['üí´','Galaxy Heart'],['üå†','Nebula Crown'],['ü™ê','Planet Forge']],
  eternal:   [['üîÆ','Eternal Prism'],['üåô','Lunar Epoch'],['üåÄ','Time Spiral']],
  celestial: [['üåå','Celestial Crown'],['üí´','Star Weaver'],['‚òÑÔ∏è','Comet Throne']],
  transcendent:[['‚ú®','Beyond Mortal'],['üåü','Ascension Orb'],['üíé','Transcendent Gem']],
  divine:    [['‚ú®','The First Light'],['üå†','Soul of Creation'],['üåü','Infinity Shard'],
               ['üïäÔ∏è','Divine Feather'],['‚öóÔ∏è','Sacred Elixir'],['üèõÔ∏è','God\'s Pillar'],['üåÖ','Dawn Eternal']],
  ancient:   [['üóø','Elder Monolith'],['üìø','Ancient Beads'],['üè∫','Timeless Urn'],['ü™ô','Forgotten Coin']],
  mythic:    [['üåÄ','Gravity Core'],['üî•','Primordial Flame'],['üíß','God\'s Tear'],
               ['üåã','Volcano Heart'],['üßø','Mythic Eye'],['ü™¨','Fate Ward'],['üê≤','Ancient Wyrm']],
  exalted:   [['üëÅÔ∏è','All-Seeing Eye'],['üî±','Exalted Trident'],['‚öúÔ∏è','Royal Emblem'],['üé≠','Sovereign Mask']],
  legendary: [['üëë','Crown of Ages'],['üêâ','Dragonheart'],['‚≠ê','Starblade'],['‚è≥','Time Fragment'],
               ['üóùÔ∏è','Master Key'],['üìø','Dragon Rosary'],['üé¥','Fate Sigil'],['üõ°Ô∏è','Aegis Ward']],
  epic:      [['üëÅÔ∏è','Spectral Eye'],['‚ö°','Thunder Rune'],['üåë','Void Orb'],['üìï','Ancient Tome'],
               ['üß•','Phantom Cloak'],['üí†','Soul Prism'],['üîÜ','Ember Core'],['üó°Ô∏è','Shadow Blade'],['üåí','Eclipse Gem']],
  rare:      [['üíé','Soul Crystal'],['üó°Ô∏è','Elven Dagger'],['üíç','Sapphire Ring'],['üìú','Arcane Scroll'],
               ['üó∫Ô∏è','Explorer\'s Map'],['üî±','Trident Shard'],['ü¶ã','Moon Wing'],['üå∫','Spirit Bloom'],['üé≠','Masque']],
  uncommon:  [['üîÆ','Jade Amulet'],['ü™ô','Silver Coin'],['üèπ','Forest Bow'],['üèÆ','Storm Lantern'],
               ['üõ°Ô∏è','Iron Shield'],['üå±','Life Root'],['üê∫','Wolf Pelt'],['üß≤','Lodestone'],['üéµ','Song Shard']],
  common:    [['üåø','Common Herb'],['ü™®','Iron Pebble'],['ü•Ñ','Bent Spoon'],['üó∫Ô∏è','Dusty Map'],
               ['ü™û','Cracked Mirror'],['üßª','Torn Scroll'],['üçÇ','Withered Leaf'],['ü™µ','Rough Wood'],['üßÇ','Salt Pinch']],
};

const ITEM_THEMES = {
  // Primordial items
  'üí†':{bg:'radial-gradient(ellipse at 50% 50%,#001a25,#000)',fx:'nova'},
  'üóø':{bg:'radial-gradient(ellipse at 50% 50%,#1a1510,#000)',fx:'starburst'},
  'üè∫':{bg:'radial-gradient(ellipse at 50% 50%,#1a1208,#000)',fx:'vortex'},
  '‚öúÔ∏è':{bg:'radial-gradient(ellipse at 50% 50%,#1a1500,#000)',fx:'starburst'},
  // Existing items
  'üåä':{bg:'radial-gradient(ellipse at 50% 50%,#002030,#000)',fx:'tearfall'},
  '‚öõÔ∏è':{bg:'radial-gradient(ellipse at 50% 50%,#001530,#000)',fx:'nova'},
  'ü™ê':{bg:'radial-gradient(ellipse at 50% 50%,#100020,#000)',fx:'vortex'},
  'üåê':{bg:'radial-gradient(ellipse at 50% 50%,#001820,#000)',fx:'nova'},
  'üí•':{bg:'radial-gradient(ellipse at 50% 50%,#200010,#000)',fx:'nova'},
  '‚ö°':{bg:'radial-gradient(ellipse at 50% 50%,#101500,#000)',fx:'starburst'},
  'üß¨':{bg:'radial-gradient(ellipse at 50% 50%,#001520,#000)',fx:'nova'},
  'üîÆ':{bg:'radial-gradient(ellipse at 50% 50%,#0a0020,#000)',fx:'starburst'},
  'üåô':{bg:'radial-gradient(ellipse at 50% 50%,#050015,#000)',fx:'meteors'},
  'üåÄ':{bg:'radial-gradient(ellipse at 50% 50%,#050018,#000)',fx:'vortex'},
  'üåå':{bg:'radial-gradient(ellipse at 50% 50%,#080018,#000)',fx:'starburst'},
  'üí´':{bg:'radial-gradient(ellipse at 50% 50%,#100025,#000)',fx:'nova'},
  '‚òÑÔ∏è':{bg:'radial-gradient(ellipse at 50% 50%,#150010,#000)',fx:'meteors'},
  '‚ú®':{bg:'radial-gradient(ellipse at 50% 50%,#1a0020,#000)',fx:'starburst'},
  'üå†':{bg:'radial-gradient(ellipse at 50% 50%,#000820,#000)',fx:'meteors'},
  'üåü':{bg:'radial-gradient(ellipse at 50% 50%,#001510,#000)',fx:'nova'},
  'üïäÔ∏è':{bg:'radial-gradient(ellipse at 50% 50%,#001a1a,#000)',fx:'nova'},
  '‚öóÔ∏è':{bg:'radial-gradient(ellipse at 50% 50%,#1a0010,#000)',fx:'starburst'},
  'üèõÔ∏è':{bg:'radial-gradient(ellipse at 50% 50%,#181800,#000)',fx:'nova'},
  'üåÖ':{bg:'radial-gradient(ellipse at 50% 50%,#1a0800,#000)',fx:'inferno'},
  'üî•':{bg:'radial-gradient(ellipse at 50% 50%,#1a0500,#000)',fx:'inferno'},
  'üíß':{bg:'radial-gradient(ellipse at 50% 50%,#000d1a,#000)',fx:'tearfall'},
  'üåã':{bg:'radial-gradient(ellipse at 50% 50%,#1a0300,#000)',fx:'inferno'},
  'üßø':{bg:'radial-gradient(ellipse at 50% 50%,#050015,#000)',fx:'vortex'},
  'ü™¨':{bg:'radial-gradient(ellipse at 50% 50%,#0a0015,#000)',fx:'vortex'},
  'üê≤':{bg:'radial-gradient(ellipse at 50% 50%,#0a1500,#000)',fx:'inferno'},
};

// ‚îÄ‚îÄ SHOP ‚Äî Luck Boosts only ‚îÄ‚îÄ
const LUCK_BOOSTS = [
  {id:'lb5',   icon:'üåø', name:'Fate Spark',      mins:5,   price:500,    shift:0.10, desc:'Mild luck shift for 5 minutes'},
  {id:'lb10',  icon:'üçÄ', name:'Fortune Mist',    mins:10,  price:1500,   shift:0.16, desc:'Moderate luck boost for 10 minutes'},
  {id:'lb25',  icon:'üå†', name:'Fortune Aura',    mins:25,  price:5000,   shift:0.24, desc:'Strong luck boost for 25 minutes'},
  {id:'lb60',  icon:'‚ú®', name:'Cosmic Blessing', mins:60,  price:45000,  shift:0.34, desc:'Powerful luck boost for 1 hour'},
  {id:'lb180', icon:'üåå', name:'Destiny Pact',    mins:180, price:200000, shift:0.44, desc:'Supreme luck for 3 hours'},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let S = {
  total:0, bestIdx:-1, coins:0, counts:{},
  inventory:{}, upgrades:[], playerName:'',
  activeLuck: null,   // {endTime, shift, name}
  customRarities: []  // Custom admin-created rarities
};
ORDER.forEach(k => S.counts[k] = 0);

let newItems = new Set();
let rolling = false, autoInt = null;
let cinematicActive = false, pendingResumeAuto = false;
let currentTab = 'roll', activeFilter = 'all';
let boostTick = null;
let gameStarted = false;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN EMAIL WHITELIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Only these email addresses can access admin features
// ‚ö†Ô∏è  SECURITY: Only add emails YOU personally control here.
// Anyone in this list gets full admin access to the panel.
// Email check is case-insensitive ‚Äî always store as lowercase.
const ADMIN_EMAILS = [
  'ibunnz10@gmail.com',
  // 'trustedfriend@gmail.com',  // uncomment to add more admins
];

let currentUserEmail = null;
let isAdmin = false;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CUSTOM RARITIES & ITEMS EDITOR SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let customRarities = [];
let customItems = {};
let editingRarityIndex = null;
let editingItemKey = null;
let uploadedImageData = null;

// Load custom data from localStorage on init
function loadCustomData() {
  try {
    const saved = localStorage.getItem('fateRoll_customData');
    if (saved) {
      const data = JSON.parse(saved);
      customRarities = data.rarities || [];
      customItems = data.items || {};
      
      // Integrate custom rarities into RARITIES array
      customRarities.forEach(cr => {
        if (!RARITIES.find(r => r.key === cr.key)) {
          RARITIES.push(cr);
          ORDER.push(cr.key);
          if (!ITEMS[cr.key]) ITEMS[cr.key] = [];
        }
      });
      
      // Integrate custom items into ITEMS
      Object.keys(customItems).forEach(rarityKey => {
        if (!ITEMS[rarityKey]) ITEMS[rarityKey] = [];
        customItems[rarityKey].forEach(item => {
          if (!ITEMS[rarityKey].find(i => i[0] === item[0] && i[1] === item[1])) {
            ITEMS[rarityKey].push(item);
          }
        });
      });
    }
  } catch(e) {
    console.error('Failed to load custom data:', e);
  }
}

// Save custom data to localStorage
function saveCustomData() {
  try {
    const data = {
      rarities: customRarities,
      items: customItems
    };
    localStorage.setItem('fateRoll_customData', JSON.stringify(data));
    return true;
  } catch(e) {
    console.error('Failed to save custom data:', e);
    return false;
  }
}

// Render rarities in editor
function renderEditorRarities() {
  const list = document.getElementById('editorRarityList');
  const select = document.getElementById('itemRaritySelect');
  if (!list || !select) return;
  
  list.innerHTML = '';
  let selectHTML = '<option value="">Choose a rarity...</option>';
  
  RARITIES.forEach((r, index) => {
    const isCustom = customRarities.find(cr => cr.key === r.key);
    const div = document.createElement('div');
    div.className = 'editor-rarity-item';
    div.innerHTML = `
      <div class="editor-rarity-color" style="background:${r.color}" onclick="editRarity(${index})"></div>
      <div class="editor-rarity-info">
        <div class="editor-rarity-name" style="color:${r.color}">${r.emoji} ${r.label}</div>
        <div class="editor-rarity-chance">${r.chance}% chance</div>
      </div>
      <button class="editor-btn" onclick="editRarity(${index})">‚úèÔ∏è Edit</button>
      ${isCustom ? '<button class="editor-btn danger" onclick="deleteRarity('+index+')">üóëÔ∏è Delete</button>' : '<span style="font-size:.65rem;color:var(--muted);">Built-in</span>'}
    `;
    list.appendChild(div);
    
    selectHTML += `<option value="${r.key}">${r.emoji} ${r.label}</option>`;
  });
  
  select.innerHTML = selectHTML;
}

// Render items in editor
function renderEditorItems() {
  const rarityKey = document.getElementById('itemRaritySelect').value;
  const list = document.getElementById('editorItemList');
  if (!list) return;
  
  if (!rarityKey) {
    list.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--muted);padding:20px;">Select a rarity to view/edit items</div>';
    return;
  }
  
  const items = ITEMS[rarityKey] || [];
  const rarity = RARITIES.find(r => r.key === rarityKey);
  
  if (items.length === 0) {
    list.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--muted);padding:20px;">No items yet. Add one below!</div>';
    return;
  }
  
  list.innerHTML = '';
  items.forEach((item, index) => {
    const [emoji, name] = item;
    const isImage = emoji.startsWith('data:image');
    const itemKey = `${rarityKey}|${index}`;
    const isCustom = customItems[rarityKey] && customItems[rarityKey].find(ci => ci[1] === name);
    
    const div = document.createElement('div');
    div.className = 'editor-item-card';
    div.style.borderColor = rarity.color + '40';
    div.innerHTML = `
      <div class="editor-item-preview">
        <div class="editor-item-emoji">
          ${isImage ? '<img src="'+emoji+'">' : emoji}
        </div>
        <div class="editor-item-details">
          <div class="editor-item-name">${name}</div>
          <div class="editor-item-rarity" style="color:${rarity.color}">${rarity.label}</div>
        </div>
      </div>
      <div class="editor-item-actions">
        <button class="editor-btn" onclick="editItem('${rarityKey}',${index})" style="flex:1;">‚úèÔ∏è Edit</button>
        ${isCustom ? '<button class="editor-btn danger" onclick="deleteItem(\''+rarityKey+'\','+index+')">üóëÔ∏è</button>' : '<span style="font-size:.6rem;color:var(--muted);padding:6px;">Built-in</span>'}
      </div>
    `;
    list.appendChild(div);
  });
}

// Save/Edit rarity
window.saveRarity = function() {
  const name = document.getElementById('rarityName').value.trim();
  const color = document.getElementById('rarityColor').value.trim();
  const chance = parseFloat(document.getElementById('rarityChance').value);
  const emoji = document.getElementById('rarityEmoji').value.trim();
  
  if (!name || !color || !chance || !emoji) {
    notify('Please fill all rarity fields', 'err');
    return;
  }
  
  if (chance <= 0 || chance > 100) {
    notify('Chance must be between 0 and 100', 'err');
    return;
  }
  
  const key = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
  
  if (editingRarityIndex !== null) {
    // Edit existing rarity
    const rarity = RARITIES[editingRarityIndex];
    const customIndex = customRarities.findIndex(cr => cr.key === rarity.key);
    
    rarity.label = name;
    rarity.color = color;
    rarity.chance = chance;
    rarity.emoji = emoji;
    
    if (customIndex >= 0) {
      customRarities[customIndex] = rarity;
    }
    
    notify('Rarity updated!', 'ok');
    editingRarityIndex = null;
    document.querySelector('#rarityForm .editor-btn.primary').textContent = '‚ûï CREATE RARITY';
  } else {
    // Add new rarity
    if (RARITIES.find(r => r.key === key)) {
      notify('Rarity with this name already exists', 'err');
      return;
    }
    
    const newRarity = {
      key: key,
      label: name,
      emoji: emoji,
      color: color,
      chance: chance,
      fx: 1 // default effect level
    };
    
    RARITIES.push(newRarity);
    ORDER.push(key);
    ITEMS[key] = [];
    customRarities.push(newRarity);
    
    notify('Custom rarity added!', 'ok');
  }
  
  saveCustomData();
  renderEditorRarities();
  renderEditorItems();
  updateUI();
  
  // Clear form
  document.getElementById('rarityName').value = '';
  document.getElementById('rarityColor').value = '';
  document.getElementById('rarityChance').value = '';
  document.getElementById('rarityEmoji').value = '';
};

// Edit rarity
window.editRarity = function(index) {
  editingRarityIndex = index;
  const rarity = RARITIES[index];
  
  document.getElementById('rarityName').value = rarity.label;
  document.getElementById('rarityColor').value = rarity.color;
  document.getElementById('rarityColorPicker').value = rarity.color;
  document.getElementById('rarityChance').value = rarity.chance;
  document.getElementById('rarityEmoji').value = rarity.emoji;
  
  document.querySelector('#rarityForm .editor-btn.primary').textContent = 'üíæ UPDATE RARITY';
  document.getElementById('rarityName').scrollIntoView({behavior: 'smooth', block: 'center'});
  notify('Editing rarity - click Update to save changes', 'info');
};

// Delete rarity
window.deleteRarity = function(index) {
  const rarity = RARITIES[index];
  const isCustom = customRarities.find(cr => cr.key === rarity.key);
  
  if (!isCustom) {
    notify('Cannot delete built-in rarities', 'err');
    return;
  }
  
  if (!confirm(`Delete rarity "${rarity.label}" and all its items?`)) return;
  
  // Remove from arrays
  RARITIES.splice(index, 1);
  const orderIndex = ORDER.indexOf(rarity.key);
  if (orderIndex >= 0) ORDER.splice(orderIndex, 1);
  delete ITEMS[rarity.key];
  delete customItems[rarity.key];
  
  const customIndex = customRarities.findIndex(cr => cr.key === rarity.key);
  if (customIndex >= 0) customRarities.splice(customIndex, 1);
  
  saveCustomData();
  renderEditorRarities();
  renderEditorItems();
  updateUI();
  notify('Rarity deleted', 'ok');
};

// Handle image upload
window.handleImageUpload = function(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (!file.type.startsWith('image/')) {
    notify('Please upload an image file', 'err');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    uploadedImageData = e.target.result;
    document.getElementById('imagePreview').style.display = 'block';
    document.getElementById('imagePreviewImg').src = uploadedImageData;
    document.getElementById('itemEmoji').value = '[IMAGE]';
    notify('Image uploaded! Click Create to save item', 'ok');
  };
  reader.readAsDataURL(file);
};

// Save/Edit item
window.saveItem = function() {
  const rarityKey = document.getElementById('itemRaritySelect').value;
  const name = document.getElementById('itemName').value.trim();
  let emoji = document.getElementById('itemEmoji').value.trim();
  
  if (!rarityKey) {
    notify('Please select a rarity first', 'err');
    return;
  }
  
  if (!name) {
    notify('Please enter an item name', 'err');
    return;
  }
  
  if (!emoji && !uploadedImageData) {
    notify('Please enter an emoji or upload an image', 'err');
    return;
  }
  
  // Use uploaded image if available
  if (uploadedImageData) {
    emoji = uploadedImageData;
  }
  
  if (editingItemKey) {
    // Edit existing item
    const [editRarityKey, editIndex] = editingItemKey.split('|');
    const index = parseInt(editIndex);
    ITEMS[editRarityKey][index] = [emoji, name];
    
    // Update custom items if it exists there
    if (customItems[editRarityKey]) {
      const customIndex = customItems[editRarityKey].findIndex(ci => ci[1] === name);
      if (customIndex >= 0) {
        customItems[editRarityKey][customIndex] = [emoji, name];
      }
    }
    
    notify('Item updated!', 'ok');
    editingItemKey = null;
  } else {
    // Add new item
    if (!ITEMS[rarityKey]) ITEMS[rarityKey] = [];
    ITEMS[rarityKey].push([emoji, name]);
    
    if (!customItems[rarityKey]) customItems[rarityKey] = [];
    customItems[rarityKey].push([emoji, name]);
    
    notify('Custom item added!', 'ok');
  }
  
  saveCustomData();
  renderEditorItems();
  
  // Clear form
  document.getElementById('itemName').value = '';
  document.getElementById('itemEmoji').value = '';
  document.getElementById('itemImageUpload').value = '';
  document.getElementById('imagePreview').style.display = 'none';
  uploadedImageData = null;
};

// Edit item
window.editItem = function(rarityKey, index) {
  const item = ITEMS[rarityKey][index];
  const [emoji, name] = item;
  
  editingItemKey = `${rarityKey}|${index}`;
  document.getElementById('itemRaritySelect').value = rarityKey;
  document.getElementById('itemName').value = name;
  
  if (emoji.startsWith('data:image')) {
    uploadedImageData = emoji;
    document.getElementById('imagePreview').style.display = 'block';
    document.getElementById('imagePreviewImg').src = emoji;
    document.getElementById('itemEmoji').value = '[IMAGE]';
  } else {
    document.getElementById('itemEmoji').value = emoji;
    uploadedImageData = null;
  }
  
  renderEditorItems();
  document.getElementById('itemName').scrollIntoView({behavior: 'smooth', block: 'center'});
  notify('Editing item - click Create to save changes', 'info');
};

// Delete item
window.deleteItem = function(rarityKey, index) {
  const item = ITEMS[rarityKey][index];
  const isCustom = customItems[rarityKey] && customItems[rarityKey].find(ci => ci[1] === item[1]);
  
  if (!isCustom) {
    notify('Cannot delete built-in items', 'err');
    return;
  }
  
  if (!confirm(`Delete item "${item[1]}"?`)) return;
  
  ITEMS[rarityKey].splice(index, 1);
  
  const customIndex = customItems[rarityKey].findIndex(ci => ci[1] === item[1]);
  if (customIndex >= 0) {
    customItems[rarityKey].splice(customIndex, 1);
  }
  
  saveCustomData();
  renderEditorItems();
  notify('Item deleted', 'ok');
};

// Export custom data
window.exportCustomData = function() {
  const data = {
    rarities: customRarities,
    items: customItems,
    exportDate: new Date().toISOString()
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'fate-roll-custom-data.json';
  a.click();
  URL.revokeObjectURL(url);
  
  notify('Custom data exported!', 'ok');
};

// Import custom data
window.importCustomData = function() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'application/json';
  input.onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(event) {
      try {
        const data = JSON.parse(event.target.result);
        
        if (!data.rarities || !data.items) {
          notify('Invalid custom data file', 'err');
          return;
        }
        
        customRarities = data.rarities;
        customItems = data.items;
        
        // Clear existing custom data from arrays
        RARITIES = RARITIES.filter(r => !customRarities.find(cr => cr.key === r.key));
        ORDER = ORDER.filter(k => !customRarities.find(cr => cr.key === k));
        
        // Re-add imported data
        customRarities.forEach(cr => {
          RARITIES.push(cr);
          ORDER.push(cr.key);
          if (!ITEMS[cr.key]) ITEMS[cr.key] = [];
        });
        
        Object.keys(customItems).forEach(rarityKey => {
          customItems[rarityKey].forEach(item => {
            if (!ITEMS[rarityKey].find(i => i[0] === item[0] && i[1] === item[1])) {
              ITEMS[rarityKey].push(item);
            }
          });
        });
        
        saveCustomData();
        renderEditorRarities();
        renderEditorItems();
        updateUI();
        
        notify('Custom data imported!', 'ok');
      } catch(err) {
        console.error(err);
        notify('Failed to import data', 'err');
      }
    };
    reader.readAsText(file);
  };
  input.click();
};

// Reset custom data
window.resetCustomData = function() {
  if (!confirm('This will delete ALL custom rarities and items. Are you sure?')) return;
  
  // Remove custom rarities from RARITIES
  customRarities.forEach(cr => {
    const index = RARITIES.findIndex(r => r.key === cr.key);
    if (index >= 0) RARITIES.splice(index, 1);
    
    const orderIndex = ORDER.indexOf(cr.key);
    if (orderIndex >= 0) ORDER.splice(orderIndex, 1);
    
    delete ITEMS[cr.key];
  });
  
  // Remove custom items from ITEMS
  Object.keys(customItems).forEach(rarityKey => {
    if (ITEMS[rarityKey]) {
      customItems[rarityKey].forEach(customItem => {
        const index = ITEMS[rarityKey].findIndex(i => i[1] === customItem[1]);
        if (index >= 0) ITEMS[rarityKey].splice(index, 1);
      });
    }
  });
  
  customRarities = [];
  customItems = {};
  
  localStorage.removeItem('fateRoll_customData');
  
  renderEditorRarities();
  renderEditorItems();
  updateUI();
  
  notify('All custom data reset', 'ok');
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE CONFIG - Replace with your own Firebase config
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETUP INSTRUCTIONS:
// 1. Create a Firebase project at https://console.firebase.google.com/
// 2. Enable Realtime Database in your project
// 3. Enable Google Authentication (Authentication ‚Üí Sign-in method ‚Üí Google)
// 4. Get your config from Project Settings ‚Üí Your apps ‚Üí Web app
// 5. Replace the values below with your actual Firebase config
// 6. See FIREBASE_SETUP.md for detailed instructions
//
// NOTE: The game will work without Firebase, but the leaderboard won't function.
// All other features (rolling, inventory, shop, etc.) work perfectly offline.
// Admin features require Google Sign-In to be enabled in Firebase.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë  SECURITY CHECKLIST ‚Äî DO THESE IN FIREBASE CONSOLE          ‚ïë
// ‚ïë  1. Authentication ‚Üí Settings ‚Üí Authorized Domains          ‚ïë
// ‚ïë     Only: localhost + ibunnz.github.io                      ‚ïë
// ‚ïë  2. Realtime Database ‚Üí Rules ‚Üí paste these rules:          ‚ïë
// ‚ïë     { "rules": { "leaderboard": {                           ‚ïë
// ‚ïë       ".read": true,                                        ‚ïë
// ‚ïë       "$uid": { ".write": "auth != null &&                  ‚ïë
// ‚ïë                 $uid === auth.uid" } } } }                  ‚ïë
// ‚ïë  3. NEVER put Admin SDK JSON or private_key here            ‚ïë
// ‚ïë  The apiKey below is PUBLIC by design ‚Äî that's fine.        ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
const FIREBASE_CONFIG = {
 apiKey: "AIzaSyArY8CoNqqlgk04odFZs8p4Rhx2hw-w0Q0",
  authDomain: "fate-rng.firebaseapp.com",
  databaseURL: "https://fate-rng-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "fate-rng",
  storageBucket: "fate-rng.firebasestorage.app",
  messagingSenderId: "461740068846",
  appId: "1:461740068846:web:59174ab7e0a20f65d608ff",
  measurementId: "G-7586KJM8DF"
};

let firebaseApp = null;
let database = null;
let auth = null;
let FIREBASE_READY = false;

// Initialize Firebase
function initFirebase() {
  try {
    // Check if Firebase is loaded
    if (typeof firebase === 'undefined') {
      console.warn('Firebase SDK not loaded');
      return;
    }
    
    // Check if config is set up
    if (FIREBASE_CONFIG.apiKey === "YOUR_API_KEY") {
      console.warn('‚ö†Ô∏è Firebase not configured. Leaderboard will not work.');
      console.log('üìö See FIREBASE_SETUP.md for setup instructions.');
      console.log('üéÆ All other game features work without Firebase!');
      return;
    }
    
    firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
    database = firebase.database();
    auth = firebase.auth();
    FIREBASE_READY = true;
    console.log('‚úÖ Firebase initialized successfully');
    
    // Set up auth state listener
    auth.onAuthStateChanged((user) => {
      if (user && user.email) {
        currentUserEmail = user.email;
        isAdmin = ADMIN_EMAILS.some(e => e.toLowerCase() === (user.email || '').toLowerCase());
        console.log('üîê Signed in as:', user.email);
        if (isAdmin) {
          console.log('üëë Admin access granted');
        }
        updateAdminUI();
        
        // If user signs in while on username screen, update it
        const signInStep = document.getElementById('signInStep');
        const usernameStep = document.getElementById('usernameStep');
        const emailDisplay = document.getElementById('signedInEmail');
        
        if (signInStep && usernameStep && signInStep.style.display !== 'none') {
          signInStep.style.display = 'none';
          usernameStep.style.display = 'block';
          if (emailDisplay) emailDisplay.textContent = user.email;
          setTimeout(() => {
            const input = document.getElementById('unInput');
            if (input) input.focus();
          }, 100);
        }
      } else {
        currentUserEmail = null;
        isAdmin = false;
        updateAdminUI();
      }
    });
  } catch(e) {
    console.error('‚ùå Firebase initialization failed:', e);
    console.log('üìö Check FIREBASE_SETUP.md for troubleshooting.');
    FIREBASE_READY = false;
  }
}

// Update UI based on admin status
function updateAdminUI() {
  const adminBtn = document.getElementById('adminBtn');
  const signInBtn = document.getElementById('signInBtn');
  
  if (signInBtn) {
    // Show Sign In button when not signed in, hide when signed in
    signInBtn.style.display = currentUserEmail ? 'none' : '';
    // Update text if signed in but not admin
    if (currentUserEmail && !isAdmin) {
      signInBtn.style.display = '';
      signInBtn.textContent = 'üë§ ' + currentUserEmail.split('@')[0];
      signInBtn.onclick = signOutAdmin;
    }
  }
  
  if (adminBtn) {
    // Show Admin button only if user is admin
    adminBtn.style.display = isAdmin ? '' : 'none';
  }
  
  // Show Editor tab only for admins
  const editorTab = document.getElementById('tab-editor');
  if (editorTab) {
    editorTab.style.display = isAdmin ? '' : 'none';
  }
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// USERNAME CONTENT FILTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BLOCKED_WORDS = [
  // Racial slurs and variants
  'nig','niga','nigg','nigr','n1g','n1gg','niqq','niqa','niqg',
  // Common profanity
  'fuck','fuk','fck','f4ck','fuq','phuck',
  'shit','sh1t','sht','shyt',
  'bitch','b1tch','btch','biatch',
  'ass','a55','azz','asz',
  'dick','d1ck','dik','dck',
  'cock','c0ck','cok','cck',
  'cunt','cnt','kunt',
  'damn','dmn','dam',
  'hell','hel','h3ll',
  // Other offensive terms
  'fag','f4g','phag',
  'retard','tard','r3tard',
  'rape','r4pe','rpe',
  'nazi','nzi','n4zi',
  'kill','kil','kll','k1ll',
  'die','d1e',
  'kys',
  // Add more as needed
];

function containsBlockedContent(username) {
  const clean = username.toLowerCase().replace(/[^a-z0-9]/g, '');
  
  // Check for exact matches and substrings
  for (const word of BLOCKED_WORDS) {
    if (clean.includes(word)) {
      return true;
    }
  }
  
  // Check for leet speak variations
  const leet = clean
    .replace(/0/g, 'o')
    .replace(/1/g, 'i')
    .replace(/3/g, 'e')
    .replace(/4/g, 'a')
    .replace(/5/g, 's')
    .replace(/7/g, 't')
    .replace(/8/g, 'b');
  
  for (const word of BLOCKED_WORDS) {
    if (leet.includes(word)) {
      return true;
    }
  }
  
  return false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// USERNAME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startGame() {
  const v = document.getElementById('unInput').value.trim();
  const err = document.getElementById('unErr');
  
  // Length check
  if (v.length < 3 || v.length > 20) { 
    err.textContent = 'Username must be 3-20 characters';
    err.style.display = 'block'; 
    return; 
  }
  
  // Content filter check
  if (containsBlockedContent(v)) {
    err.textContent = 'Username contains inappropriate content';
    err.style.display = 'block';
    return;
  }
  
  err.style.display = 'none';
  S.playerName = v.replace(/[<>&"'`]/g, '').trim(); // strip any HTML chars
  document.getElementById('un-screen').style.display = 'none';
  gameStarted = true;
  saveGame(false);
  updateUI();
  // Submit score then load board
  submitScore().then(() => loadBoard(false));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAVE / LOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveGame(showMsg = true) {
  try {
    const snap = {...S};
    // Serialize inventory (convert rarity object to key only)
    const inv = {};
    Object.entries(S.inventory).forEach(([k,v]) => {
      inv[k] = {...v, rarity:{key:v.rarity.key}};
    });
    snap.inventory = inv;
    localStorage.setItem('fate_v5', JSON.stringify(snap));
  } catch(e) {}
  if (showMsg) notify('Saved!', 'ok');
}

function loadGame() {
  try {
    const raw = localStorage.getItem('fate_v5');
    if (raw) {
      const d = JSON.parse(raw);
      // Rehydrate rarity objects
      if (d.inventory) {
        Object.entries(d.inventory).forEach(([k,v]) => {
          const r = RARITIES.find(x => x.key === (v.rarity?.key)) || RARITIES[RARITIES.length-1];
          d.inventory[k].rarity = r;
        });
      }
      ORDER.forEach(k => { if(!d.counts) d.counts={}; if(d.counts[k]===undefined) d.counts[k]=0; });
      Object.assign(S, d);
    }
  } catch(e) { console.warn('loadGame error', e); }
}

function confirmReset() {
  closeModal('resetMod');
  const name = S.playerName;
  S = {total:0,bestIdx:-1,coins:0,counts:{},inventory:{},upgrades:[],playerName:name,activeLuck:null};
  ORDER.forEach(k => S.counts[k] = 0);
  newItems.clear();
  localStorage.removeItem('fate_v5');
  document.getElementById('histList').innerHTML = '';
  document.getElementById('idleMsg').style.display = '';
  document.getElementById('cardWrap').style.display = 'none';
  document.getElementById('rollLbl').style.visibility = 'hidden';
  updateUI(); renderInv();
  notify('Progress reset.', 'info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LEADERBOARD ‚Äî uses window.storage with shared=true
// Keys: "fate_brd_<uniqueId>" (no special chars that break prefix lists)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BOARD_PREFIX = 'fate_brd_';
let myBoardId = (() => {
  let id = localStorage.getItem('fate_bid2');
  if (!id) {
    // Safe chars only: lowercase a-z, 0-9, underscore
    const ts = Date.now().toString(36);
    const rnd = Math.random().toString(36).replace(/[^a-z0-9]/g,'').slice(0,8);
    id = ts + '_' + rnd;
    localStorage.setItem('fate_bid2', id);
  }
  return id;
})();

let lastScoreSubmit = 0;

async function submitScore() {
  if (!FIREBASE_READY) return false;
  if (!S.playerName || S.playerName.length < 1) return false;
  
  // Rate limit: only submit once per minute
  const now = Date.now();
  if (now - lastScoreSubmit < 60000) return false;
  
  const bestLabel = S.bestIdx >= 0
    ? (RARITIES.find(r => r.key === ORDER[S.bestIdx])?.label || '‚Äî')
    : '‚Äî';
  
  // Sanitise all values before sending to Firebase
  const safeName = String(S.playerName || '').slice(0, 20).replace(/[<>&"'`\\]/g, '').trim();
  const safeCoins = Math.max(0, Math.min(Math.floor(S.coins), 999999999)); // cap at ~1 billion
  const safeRolls = Math.max(0, Math.min(Math.floor(S.total), 999999999));
  if (!safeName) return false; // reject empty names

  const entry = {
    id: myBoardId,
    name: safeName,
    coins: safeCoins,
    rolls: safeRolls,
    best: bestLabel,
    ts: now
  };
  
  try {
    // Store in Firebase Realtime Database
    await database.ref('leaderboard/' + myBoardId).set(entry);
    lastScoreSubmit = now;
    return true;
  } catch(e) {
    // Don't spam console with warnings
    if (now - lastScoreSubmit > 300000) {
      console.warn('Score submit failed:', e.message || e);
    }
    return false;
  }
}

let lastBoardLoad = 0;
async function loadBoard(showMsg = true) {
  const now = Date.now();
  if (showMsg && now - lastBoardLoad < 10000) { // 10s cooldown on manual refresh
    notify('Please wait a moment before refreshing again', 'info');
    return;
  }
  lastBoardLoad = now;
  const listEl = document.getElementById('boardList');
  const statusEl = document.getElementById('boardStatus');
  listEl.innerHTML = '';
  
  // Check if Firebase is ready
  if (!FIREBASE_READY) {
    statusEl.innerHTML = '';
    listEl.innerHTML = `<div class="board-loading">
      <div style="font-size:2rem;margin-bottom:12px;">üî•</div>
      <div style="font-weight:700;margin-bottom:8px;">Leaderboard Not Set Up</div>
      <div style="color:var(--muted);font-size:.8rem;line-height:1.6;max-width:400px;margin:0 auto;">
        To enable the global leaderboard, you need to configure Firebase Realtime Database.<br><br>
        <strong style="color:var(--text);">See FIREBASE_SETUP.md for step-by-step instructions.</strong><br><br>
        Don't worry - all your game progress is saved locally and works perfectly without Firebase!<br>
        Rolling, inventory, shop, and stats all work offline.
      </div>
    </div>`;
    return;
  }
  
  statusEl.innerHTML = '<span class="board-dot" style="background:#fbbf24"></span><span>Submitting your score...</span>';

  // Submit current player's score first
  if (gameStarted) {
    await submitScore();
  }

  statusEl.innerHTML = '<span class="board-dot" style="background:#38bdf8"></span><span>Fetching rankings...</span>';

  try {
    // Fetch all leaderboard entries from Firebase
    const snapshot = await database.ref('leaderboard').once('value');
    const data = snapshot.val();
    
    if (!data) {
      statusEl.innerHTML = '';
      listEl.innerHTML = '<div class="board-loading">No entries yet ‚Äî be the first!</div>';
      return;
    }

    // Convert object to array
    const entries = [];
    for (const key in data) {
      if (data.hasOwnProperty(key)) {
        entries.push({ id: key, ...data[key] });
      }
    }

    // Sort by coins (descending)
    entries.sort((a, b) => b.coins - a.coins);

    statusEl.innerHTML = `<span class="board-dot" style="background:#4ade80"></span><span>${entries.length} player${entries.length!==1?'s':''} ranked</span>`;

    renderBoard(entries);
    if (showMsg) notify('Board updated!', 'ok');
  } catch(e) {
    statusEl.innerHTML = '';
    const errorMsg = String(e.message || e);
    
    // Check if it's a permission error
    if (errorMsg.includes('permission') || errorMsg.includes('PERMISSION_DENIED')) {
      listEl.innerHTML = `<div class="board-loading" style="color:#f43f5e">
        <div style="font-size:2rem;margin-bottom:12px;">üîí</div>
        <div style="font-weight:700;margin-bottom:12px;">Permission Denied</div>
        <div style="color:var(--muted);font-size:.8rem;line-height:1.6;max-width:500px;margin:0 auto;text-align:left;">
          <strong style="color:#fbbf24;">Fix this in 30 seconds:</strong><br><br>
          1. Go to <a href="https://console.firebase.google.com/" target="_blank" style="color:#38bdf8">Firebase Console</a><br>
          2. Click your project ‚Üí <strong>Realtime Database</strong> ‚Üí <strong>Rules</strong> tab<br>
          3. Replace all rules with:<br><br>
          <code style="background:var(--panel2);padding:8px;border-radius:4px;display:block;font-size:.75rem;color:#4ade80;margin:8px 0;">
          {<br>
          &nbsp;&nbsp;"rules": {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;"leaderboard": {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;".read": true,<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;".write": true<br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;}<br>
          }
          </code><br>
          4. Click <strong>"Publish"</strong><br>
          5. Refresh this page<br><br>
          <span style="color:var(--text);">That's it! See FIREBASE_SETUP.md for details.</span>
        </div>
      </div>`;
    } else {
      listEl.innerHTML = `<div class="board-loading" style="color:#f43f5e">Error loading leaderboard: ${esc(errorMsg)}<br>Please try again later.</div>`;
    }
    console.error('Leaderboard error:', e);
  }
}

function renderBoard(entries) {
  const list = document.getElementById('boardList');
  list.innerHTML = '';
  const medals = ['ü•á','ü•à','ü•â'];
  if (!entries.length) {
    list.innerHTML = '<div class="board-loading">No entries!</div>';
    return;
  }
  entries.slice(0, 50).forEach((e, i) => {
    const isMe = e.id === myBoardId;
    const rank = i + 1;
    const div = document.createElement('div');
    div.className = 'board-entry' + (isMe?' me':'') +
      (rank===1?' top1':rank===2?' top2':rank===3?' top3':'');
    const rStr = rank <= 3
      ? `<span style="font-size:1.08rem">${medals[rank-1]}</span>`
      : `<span class="board-rank" style="color:var(--muted)">#${rank}</span>`;
    const col = (e.best && e.best !== '‚Äî')
      ? (RARITIES.find(r => r.label === e.best)?.color || 'var(--muted)')
      : 'var(--muted)';
    div.innerHTML = `${rStr}
      <span class="board-name">${esc(e.name||'?')}${isMe?'<span class="you-tag">YOU</span>':''}</span>
      <span class="board-coins">ü™ô ${(e.coins||0).toLocaleString()}</span>
      <span class="board-rolls">${(e.rolls||0).toLocaleString()}</span>
      <span class="board-best" style="color:${col}">${esc(e.best||'‚Äî')}</span>`;
    list.appendChild(div);
  });
}
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOST SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getLuckShift() {
  if (!S.activeLuck) return 0;
  if (Date.now() >= S.activeLuck.endTime) { S.activeLuck = null; updateBoostUI(); return 0; }
  return S.activeLuck.shift;
}

function updateBoostUI() {
  const pill = document.getElementById('boostPill');
  if (!S.activeLuck || Date.now() >= S.activeLuck.endTime) {
    pill.classList.remove('on'); return;
  }
  pill.classList.add('on');
  const rem = Math.ceil((S.activeLuck.endTime - Date.now()) / 1000);
  document.getElementById('boostTxt').textContent = '‚ö° LUCK';
  document.getElementById('boostTimer').textContent = fmtTime(rem);
}

function fmtTime(s) {
  if (s >= 3600) return Math.floor(s/3600)+'h '+Math.floor((s%3600)/60)+'m';
  if (s >= 60) return Math.floor(s/60)+'m '+('0'+Math.floor(s%60)).slice(-2)+'s';
  return s+'s';
}

function startBoostTick() {
  if (boostTick) clearInterval(boostTick);
  boostTick = setInterval(() => {
    updateBoostUI();
    if (currentTab === 'shop') renderShop();
  }, 1000);
}

function buyBoost(id) {
  const b = LUCK_BOOSTS.find(x => x.id === id);
  if (!b) return;
  if (S.coins < b.price) { notify('Not enough coins!', 'err'); return; }
  // Check if a boost is already active
  if (S.activeLuck && Date.now() < S.activeLuck.endTime) {
    notify('A luck boost is already active!', 'err'); return;
  }
  S.coins -= b.price;
  S.activeLuck = { endTime: Date.now() + b.mins * 60 * 1000, shift: b.shift, name: b.name };
  updateBoostUI();
  updateUI();
  renderShop();
  notify(`${b.name} activated for ${b.mins}min!`, 'ok');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUILD TABLE & FILTERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function buildTable() {
  const t = document.getElementById('rarTable');
  const maxPct = RARITIES[RARITIES.length-1].pct;
  RARITIES.forEach(r => {
    const w = Math.max(0.2, (r.pct/maxPct)*100).toFixed(2);
    const pStr = r.pct < 0.01 ? r.pct.toFixed(3)+'%' : r.pct < 0.1 ? r.pct.toFixed(3)+'%' : r.pct < 1 ? r.pct.toFixed(2)+'%' : r.pct+'%';
    const row = document.createElement('div'); row.className = 'rar-row';
    row.innerHTML = `<span class="rar-name" style="color:${r.color}">${r.label}</span>
      <span class="rar-pct">${pStr}</span>
      <div class="bar-bg"><div class="bar-fill" style="width:${w}%;background:${r.color};box-shadow:0 0 4px ${r.color}44"></div></div>
      <span class="rar-cnt" id="cnt-${r.key}">0</span>`;
    t.appendChild(row);
  });
})();

(function buildFilters() {
  const tb = document.getElementById('invToolbar');
  const sort = document.getElementById('invSort');
  RARITIES.forEach(r => {
    const btn = document.createElement('button'); btn.className = 'inv-filt';
    btn.id = 'filt-'+r.key; btn.textContent = r.label;
    btn.style.color = r.color; btn.style.borderColor = r.color+'44';
    btn.onclick = () => setFilter(r.key);
    tb.insertBefore(btn, sort);
  });
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ROLL ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getRarity(v) {
  const shift = getLuckShift();
  if (shift > 0) v = Math.pow(v, 1 + shift * 2.2); // power bias toward 0 = rarer
  for (const r of RARITIES) if (v < r.threshold) return r;
  return RARITIES[RARITIES.length - 1];
}

function doRoll() {
  if (rolling || cinematicActive) return;
  rolling = true;
  const rand = Math.random();
  const r = getRarity(rand);
  const pool = ITEMS[r.key];
  const [emoji, name] = pool[Math.floor(Math.random() * pool.length)];

  S.total++;
  S.counts[r.key]++;
  const ri = ORDER.indexOf(r.key);
  const newBest = ri > S.bestIdx;
  if (newBest) S.bestIdx = ri;

  const earned = COIN_REWARDS[r.key] || 1;
  S.coins += earned;

  const iKey = `${emoji}|${name}|${r.key}`;
  if (!S.inventory[iKey]) {
    S.inventory[iKey] = {emoji, name, rarity:r, count:0, firstRollNum:S.total};
    newItems.add(iKey);
  }
  S.inventory[iKey].count++;

  updateUI();
  addHist(r, emoji, name, earned);
  if (currentTab === 'inv') renderInv();
  if (currentTab === 'shop') renderShop();
  if (newBest && S.total > 1) {
    const t = document.getElementById('toast'); t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
  }
  if (currentTab === 'roll') showCoinPop('+' + earned.toLocaleString());

  // Cinematic for ultra-rare ‚Äî only if user is on the roll tab
  if (r.fx >= 9) {
    if (currentTab === 'roll') {
      if (autoInt) {
        pendingResumeAuto = true;
        stopAuto();
      }
      rolling = false;
      triggerCin(r, emoji, name, earned);
      return;
    }
    // On background tab ‚Äî skip cinematic, just render card silently
  }

  // Normal card (only render visually if on roll tab)
  if (currentTab === 'roll') {
    renderCard(r, emoji, name, earned);
  }
  const spd = parseInt(document.getElementById('speedSel').value);
  setTimeout(() => { rolling = false; }, spd < 600 ? 140 : 300);
}

function showCoinPop(txt) {
  const el = document.getElementById('coin-pop');
  el.textContent = txt; el.className = ''; void el.offsetWidth; el.classList.add('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CARD RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCard(r, emoji, name, earned) {
  document.getElementById('idleMsg').style.display = 'none';
  document.getElementById('cardWrap').style.display = 'block';
  const lbl = document.getElementById('rollLbl'); lbl.style.visibility = 'visible'; lbl.textContent = `ROLL #${S.total}`;
  const card = document.getElementById('card');
  card.className = 'card'; void card.offsetWidth;
  card.style.setProperty('--c', r.color);
  card.innerHTML = cardHTML(r, emoji, name, 'card-ring', earned);
  card.classList.add('show');
  spawnP(document.getElementById('pcvs'), r);
  if (r.fx >= 2) {
    const sw = document.getElementById('shock');
    sw.style.cssText = `background:${r.color}22;position:absolute;width:10px;height:10px;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);opacity:0;pointer-events:none;z-index:1`;
    void sw.offsetWidth; sw.style.animation = 'shockAnim .52s ease-out forwards';
  }
  if (r.fx >= 3) {
    const fl = document.getElementById('flash');
    fl.style.background = r.color; fl.style.animation = 'none'; void fl.offsetWidth;
    fl.style.animation = 'flashOut .33s ease forwards';
  }
}

function cardHTML(r, emoji, name, ringCls, earned) {
  const pStr = r.pct < 0.01 ? r.pct.toFixed(3)+'%' : r.pct < 0.1 ? r.pct.toFixed(3)+'%' : r.pct < 1 ? r.pct.toFixed(2)+'%' : r.pct+'%';
  const oneIn = fmtOdds(r);
  const coinLine = earned !== undefined ? `<div class="card-coin">ü™ô +${earned.toLocaleString()}</div>` : '';
  return `<div class="card-top-bar" style="background:${r.color};box-shadow:0 0 12px ${r.color}88"></div>
    <div class="card-body">
      <div class="card-icon">${emoji}</div>
      <div class="card-rar" style="color:${r.color}">${r.label}</div>
      <div class="card-name" style="color:${r.color}">${name}</div>
      <div class="card-sep" style="background:${r.color}"></div>
      <div class="card-odds">
        <div class="odds-col"><span class="odds-key">Chance</span><span class="odds-val" style="color:${r.color}">${pStr}</span></div>
        <div class="odds-col"><span class="odds-key">Odds</span><span class="odds-val" style="color:${r.color}">${oneIn}</span></div>
      </div>${coinLine}
    </div>
    <div class="${ringCls}" style="box-shadow:inset 0 0 0 1px ${r.color}44,0 0 22px ${r.color}44"></div>`;
}

function fmtOdds(r) {
  const n = 100 / r.pct;
  if (n >= 1000) return `1 in ${Math.round(n).toLocaleString()}`;
  if (n >= 10)   return `1 in ${Math.round(n)}`;
  return `1 in ${n.toFixed(1)}`;
}

function spawnP(container, r) {
  container.innerHTML = '';
  for (let i = 0; i < r.np; i++) {
    const p = document.createElement('div'); p.className = 'p';
    const a = (360/r.np)*i + Math.random()*(360/r.np);
    const d = 70+Math.random()*120, sz = 4+Math.random()*5, dur = .35+Math.random()*.3;
    p.style.cssText = `--a:${a}deg;--d:${d}px;width:${sz}px;height:${sz}px;background:${r.color};box-shadow:0 0 ${sz*2}px ${r.color};animation:pBurst ${dur}s ease-out ${Math.random()*.07}s forwards`;
    container.appendChild(p);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CINEMATIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let cinCtx=null,cinAnim=null,cinP=[],cinSkipped=false;
function triggerCin(r,emoji,name,earned){
  cinematicActive=true; cinSkipped=false;
  const el=document.getElementById('cinematic'),bg=document.getElementById('cin-bg'),
    cardEl=document.getElementById('cin-card'),lbl=document.getElementById('cin-label'),
    skip=document.getElementById('cin-skip'),canvas=document.getElementById('cin-canvas'),
    rp=document.getElementById('view-roll');
  canvas.width=rp.offsetWidth; canvas.height=rp.offsetHeight;
  cinCtx=canvas.getContext('2d');
  const theme=ITEM_THEMES[emoji]||{bg:'radial-gradient(ellipse at 50% 50%,#0a0010,#000)',fx:'starburst'};
  el.style.opacity='0'; el.classList.add('active');
  bg.style.cssText=`position:absolute;inset:0;background:${theme.bg}`;
  let op=0;
  const fi=setInterval(()=>{ op=Math.min(1,op+.05); el.style.opacity=op; if(op>=1){ clearInterval(fi); startCinFX(theme.fx,r,canvas); } },28);
  setTimeout(()=>{ cardEl.className=''; cardEl.style.background='var(--panel2)'; cardEl.innerHTML=cardHTML(r,emoji,name,'card-ring',earned); void cardEl.offsetWidth; cardEl.classList.add('reveal'); },600);
  lbl.textContent=`${r.label.toUpperCase()}  ¬∑  ${fmtOdds(r)} CHANCE`;
  lbl.className=''; void lbl.offsetWidth; lbl.classList.add('show');
  setTimeout(()=>skip.classList.add('vis'),900);
  document.getElementById('idleMsg').style.display='none';
  document.getElementById('cardWrap').style.display='block';
  const rl=document.getElementById('rollLbl'); rl.style.visibility='visible'; rl.textContent=`ROLL #${S.total}`;
  const card=document.getElementById('card'); card.className='card'; void card.offsetWidth;
  card.style.setProperty('--c',r.color); card.innerHTML=cardHTML(r,emoji,name,'card-ring',earned); card.classList.add('show');
  setTimeout(()=>{ if(!cinSkipped) skipCin(); },8000);
}
function skipCin(){
  if(cinSkipped)return; cinSkipped=true;
  const el=document.getElementById('cinematic');
  document.getElementById('cin-skip').classList.remove('vis');
  if(cinAnim){ cancelAnimationFrame(cinAnim); cinAnim=null; }
  let op=1;
  const fo=setInterval(()=>{ op=Math.max(0,op-.08); el.style.opacity=op;
    if(op<=0){ clearInterval(fo); el.classList.remove('active'); el.style.opacity='0';
      if(cinCtx) cinCtx.clearRect(0,0,cinCtx.canvas.width,cinCtx.canvas.height);
      cinP=[]; cinematicActive=false;
      if(pendingResumeAuto){ pendingResumeAuto=false; toggleAuto(); }
    } },18);
}
function startCinFX(fx,r,canvas){ cinP=[];
  if(fx==='starburst') cinStar(r.color,canvas);
  else if(fx==='meteors') cinMet(r.color,canvas);
  else if(fx==='nova') cinNova(r.color,canvas);
  else if(fx==='vortex') cinVort(r.color,canvas);
  else if(fx==='inferno') cinInf(r.color,canvas);
  else if(fx==='tearfall') cinTear(r.color,canvas);
  else cinStar(r.color,canvas);
  animCin(canvas);
}
function animCin(c){ const ctx=cinCtx; if(!ctx)return; ctx.clearRect(0,0,c.width,c.height); cinP=cinP.filter(p=>{p.update();p.draw(ctx);return p.alive;}); cinAnim=requestAnimationFrame(()=>animCin(c)); }
function cinStar(col,cv){const cx=cv.width/2,cy=cv.height/2;for(let i=0;i<200;i++){const a=Math.random()*Math.PI*2,sp=.3+Math.random()*2.5,d=30+Math.random()*Math.max(cv.width,cv.height)*.7;cinP.push({x:cx,y:cy,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,sz:1+Math.random()*3,al:.8+Math.random()*.2,col:i%3===0?'#fff':i%3===1?col:'#ffd6e0',mD:d,dist:0,alive:true,tail:[],update(){this.dist+=sp;this.x+=this.vx;this.y+=this.vy;this.tail.push({x:this.x,y:this.y});if(this.tail.length>8)this.tail.shift();if(this.dist>=this.mD)this.alive=false;},draw(ctx){ctx.save();for(let t=0;t<this.tail.length;t++){ctx.fillStyle=`rgba(255,255,255,${(t/this.tail.length)*this.al*.5})`;ctx.beginPath();ctx.arc(this.tail[t].x,this.tail[t].y,this.sz*(t/this.tail.length),0,Math.PI*2);ctx.fill();}ctx.shadowBlur=8;ctx.shadowColor=this.col;ctx.fillStyle=this.col;ctx.globalAlpha=this.al;ctx.beginPath();ctx.arc(this.x,this.y,this.sz,0,Math.PI*2);ctx.fill();ctx.restore();}});}for(let r=0;r<3;r++){const ra=80+r*100,cnt=60+r*20,sp2=.008*(r%2===0?1:-1);for(let i=0;i<cnt;i++){const ba=(i/cnt)*Math.PI*2;cinP.push({cx,cy,ra,sp:sp2,col,alive:true,a:ba,update(){this.a+=this.sp;},draw(ctx){const x=this.cx+Math.cos(this.a)*this.ra,y=this.cy+Math.sin(this.a)*this.ra,g=Math.sin(this.a*3+Date.now()*.002)*.4+.6;ctx.save();ctx.shadowBlur=12;ctx.shadowColor=this.col;ctx.fillStyle=this.col;ctx.globalAlpha=g*.7;ctx.beginPath();ctx.arc(x,y,2,0,Math.PI*2);ctx.fill();ctx.restore();}});}}}
function cinMet(col,cv){function sp(){const sx=Math.random()*cv.width*1.5-cv.width*.25,ag=.4+Math.random()*.4,spd=8+Math.random()*10;cinP.push({x:sx,y:-50,vx:Math.cos(ag)*spd,vy:Math.sin(ag)*spd,col,alive:true,al:1,sz:1.5+Math.random()*2,trail:[],update(){this.trail.push({x:this.x,y:this.y});if(this.trail.length>20)this.trail.shift();this.x+=this.vx;this.y+=this.vy;if(this.x>cv.width+100||this.y>cv.height+100)this.alive=false;if(Math.random()<.3)cinP.push({x:this.x,y:this.y,vx:(Math.random()-.5)*2,vy:(Math.random()-.5)*2,sz:Math.random()*2,al:.8,col:this.col,alive:true,life:0,mL:20,update(){this.x+=this.vx;this.y+=this.vy;this.life++;this.al=.8*(1-this.life/this.mL);if(this.life>=this.mL)this.alive=false;},draw(c){c.save();c.globalAlpha=this.al;c.fillStyle=this.col;c.beginPath();c.arc(this.x,this.y,this.sz,0,Math.PI*2);c.fill();c.restore();}});},draw(c){if(this.trail.length<2)return;c.save();for(let i=1;i<this.trail.length;i++){c.strokeStyle=`rgba(255,255,255,${(i/this.trail.length)*this.al})`;c.lineWidth=this.sz*(i/this.trail.length);c.shadowBlur=10;c.shadowColor=this.col;c.beginPath();c.moveTo(this.trail[i-1].x,this.trail[i-1].y);c.lineTo(this.trail[i].x,this.trail[i].y);c.stroke();}c.restore();}});}for(let i=0;i<15;i++)setTimeout(sp,i*200);let t=0;cinP.push({alive:true,update(){t++;if(t%18===0)sp();},draw(){}});for(let i=0;i<150;i++){const sx=Math.random()*cv.width,sy=Math.random()*cv.height,r2=Math.random()*1.5,ph=Math.random()*Math.PI*2,sp2=.02+Math.random()*.04;cinP.push({alive:true,sx,sy,r2,ph,sp2,col,update(){this.ph+=this.sp2;},draw(c){const a=Math.sin(this.ph)*.4+.5;c.save();c.globalAlpha=a;c.fillStyle='#fff';c.shadowBlur=4;c.shadowColor=this.col;c.beginPath();c.arc(this.sx,this.sy,this.r2,0,Math.PI*2);c.fill();c.restore();}});}}
function cinNova(col,cv){const cx=cv.width/2,cy=cv.height/2;for(let r=0;r<6;r++){const dl=r*12;cinP.push({cx,cy,radius:0,mR:Math.max(cv.width,cv.height)*.8,al:.9,sp:4+r*1.5,dl,t:0,col,alive:true,update(){this.t++;if(this.t<this.dl)return;this.radius+=this.sp;this.al=Math.max(0,(1-this.radius/this.mR)*.8);if(this.radius>=this.mR)this.alive=false;},draw(c){if(this.t<this.dl)return;c.save();c.globalAlpha=this.al;c.strokeStyle=this.col;c.lineWidth=2;c.shadowBlur=20;c.shadowColor=this.col;c.beginPath();c.arc(this.cx,this.cy,this.radius,0,Math.PI*2);c.stroke();c.restore();}});}for(let i=0;i<120;i++){const a=Math.random()*Math.PI*2,sp=2+Math.random()*6;cinP.push({x:cx,y:cy,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,col,alive:true,al:1,life:0,mL:80,update(){this.x+=this.vx;this.y+=this.vy;this.vx*=.97;this.vy*=.97;this.life++;this.al=1-this.life/this.mL;if(this.life>=this.mL)this.alive=false;},draw(c){c.save();c.globalAlpha=this.al;c.strokeStyle=this.col;c.lineWidth=1.5;c.shadowBlur=8;c.shadowColor=this.col;c.beginPath();c.moveTo(this.x,this.y);c.lineTo(this.x-this.vx*8,this.y-this.vy*8);c.stroke();c.restore();}});}let p=0;cinP.push({alive:true,cx,cy,col,update(){p+=.05;},draw(c){const r=40+Math.sin(p)*15,g=c.createRadialGradient(cx,cy,0,cx,cy,r*3);g.addColorStop(0,col+'cc');g.addColorStop(.3,col+'44');g.addColorStop(1,'transparent');c.save();c.globalAlpha=.6+Math.sin(p)*.2;c.fillStyle=g;c.beginPath();c.arc(cx,cy,r*3,0,Math.PI*2);c.fill();c.restore();}});}
function cinVort(col,cv){const cx=cv.width/2,cy=cv.height/2;for(let i=0;i<300;i++){const a=Math.random()*Math.PI*2,d=50+Math.random()*(Math.max(cv.width,cv.height)*.6),sp=(.02+Math.random()*.04)*(Math.random()<.5?1:-1);cinP.push({cx,cy,a,d,sp,col,alive:true,update(){this.a+=this.sp*(200/this.d);this.d=Math.max(20,this.d-.4);if(this.d<=20)this.alive=false;},draw(c){const x=this.cx+Math.cos(this.a)*this.d,y=this.cy+Math.sin(this.a)*this.d,al=Math.min(1,(this.d-20)/100),sz=.5+2*(this.d/500);c.save();c.globalAlpha=al*.8;c.fillStyle=this.col;c.shadowBlur=6;c.shadowColor=this.col;c.beginPath();c.arc(x,y,sz,0,Math.PI*2);c.fill();c.restore();}});}cinP.push({alive:true,cx,cy,col,update(){},draw(c){const g=c.createRadialGradient(cx,cy,0,cx,cy,80);g.addColorStop(0,'rgba(0,0,0,1)');g.addColorStop(.5,col+'66');g.addColorStop(1,'transparent');c.save();c.globalAlpha=.8;c.fillStyle=g;c.beginPath();c.arc(cx,cy,80,0,Math.PI*2);c.fill();c.restore();}});}
function cinInf(col,cv){function se(){cinP.push({x:cv.width/2+(Math.random()-.5)*200,y:cv.height+10,vx:(Math.random()-.5)*1.5,vy:-(2+Math.random()*4),sz:3+Math.random()*8,al:.9,col,alive:true,life:0,mL:40+Math.random()*40,update(){this.x+=this.vx+(Math.random()-.5)*.5;this.y+=this.vy;this.life++;this.sz*=.98;this.al=.9*(1-this.life/this.mL);if(this.life>=this.mL||this.sz<.5)this.alive=false;},draw(c){const g=c.createRadialGradient(this.x,this.y,0,this.x,this.y,this.sz*2);g.addColorStop(0,`rgba(255,255,180,${this.al})`);g.addColorStop(1,'transparent');c.save();c.globalAlpha=this.al;c.fillStyle=g;c.beginPath();c.arc(this.x,this.y,this.sz*2,0,Math.PI*2);c.fill();c.restore();}});}for(let i=0;i<60;i++)setTimeout(se,i*30);let t2=0;cinP.push({alive:true,update(){t2++;if(t2%3===0)se();},draw(){}});cinP.push({alive:true,col,update(){},draw(c){const g=c.createLinearGradient(0,cv.height-200,0,cv.height);g.addColorStop(0,'transparent');g.addColorStop(1,col+'88');c.save();c.globalAlpha=.5;c.fillStyle=g;c.fillRect(0,cv.height-200,cv.width,200);c.restore();}});}
function cinTear(col,cv){function st(){cinP.push({x:Math.random()*cv.width,y:-20,vx:(Math.random()-.5)*.5,vy:2+Math.random()*4,sz:3+Math.random()*6,al:.7+Math.random()*.3,col,alive:true,trail:[],update(){this.trail.push({x:this.x,y:this.y});if(this.trail.length>12)this.trail.shift();this.x+=this.vx;this.y+=this.vy;if(this.y>cv.height+20)this.alive=false;},draw(c){for(let i=0;i<this.trail.length;i++){c.save();c.globalAlpha=(i/this.trail.length)*this.al*.5;c.fillStyle=this.col;c.shadowBlur=8;c.shadowColor=this.col;c.beginPath();c.arc(this.trail[i].x,this.trail[i].y,this.sz*(i/this.trail.length),0,Math.PI*2);c.fill();c.restore();}c.save();c.globalAlpha=this.al;c.fillStyle=this.col;c.shadowBlur=15;c.shadowColor=this.col;c.beginPath();c.moveTo(this.x,this.y-this.sz*2);c.bezierCurveTo(this.x+this.sz,this.y-this.sz,this.x+this.sz,this.y+this.sz,this.x,this.y+this.sz*1.5);c.bezierCurveTo(this.x-this.sz,this.y+this.sz,this.x-this.sz,this.y-this.sz,this.x,this.y-this.sz*2);c.fill();c.restore();}});}for(let i=0;i<40;i++)setTimeout(st,i*80);let t3=0;cinP.push({alive:true,update(){t3++;if(t3%8===0)st();},draw(){}});}

const _ds=document.createElement('style');
_ds.textContent='@keyframes flashOut{0%{opacity:.25}100%{opacity:0}}@keyframes shockAnim{0%{transform:translate(-50%,-50%) scale(0);opacity:.6}100%{transform:translate(-50%,-50%) scale(26);opacity:0}}';
document.head.appendChild(_ds);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderShop() {
  const body = document.getElementById('shopBody');
  document.getElementById('shopCoins').textContent = S.coins.toLocaleString();
  const now = Date.now();
  const boostActive = S.activeLuck && now < S.activeLuck.endTime;
  const remSecs = boostActive ? Math.ceil((S.activeLuck.endTime - now) / 1000) : 0;

  let html = `<div class="shop-section">
    <div class="shop-sec-title">‚ö° Luck Boosts
      ${boostActive ? `<span style="font-family:'Orbitron',sans-serif;font-size:.58rem;color:#4ade80;font-weight:700">ACTIVE: ${esc(S.activeLuck.name)} ‚Äî ${fmtTime(remSecs)} left</span>` : ''}
    </div>
    <div class="boost-grid">`;

  LUCK_BOOSTS.forEach(b => {
    const canAfford = S.coins >= b.price;
    const isActive = boostActive && S.activeLuck.shift === b.shift;
    html += `
    <div class="boost-card${isActive?' active-boost':''}${!canAfford&&!isActive?' cant-afford':''}">
      <div class="boost-top">
        <div class="boost-icon">${b.icon}</div>
        <div class="boost-name">${b.name}</div>
        <div class="boost-desc">${b.desc}</div>
        <div class="boost-duration">‚è± ${b.mins >= 60 ? b.mins/60+'h' : b.mins+'min'}</div>
        ${isActive ? `<div class="boost-timer-disp">‚è≥ ${fmtTime(remSecs)} remaining</div>` : ''}
        <div class="boost-effect" style="color:${canAfford||isActive?'#4ade80':'var(--muted)'}">+${Math.round(b.shift*100)}% luck shift</div>
      </div>
      <div class="boost-bottom">
        <div class="boost-price">ü™ô ${b.price.toLocaleString()}</div>
        ${isActive
          ? `<button class="boost-btn active-btn" disabled>‚úì Active</button>`
          : `<button class="boost-btn" onclick="buyBoost('${b.id}')" ${!canAfford||boostActive?'disabled':''}>${!canAfford?'Need '+b.price.toLocaleString():'Buy'}</button>`
        }
      </div>
    </div>`;
  });

  html += `</div></div>
  <div class="shop-section">
    <div class="shop-sec-title">‚Ñπ How Luck Boosts Work</div>
    <div style="font-size:.76rem;color:var(--muted);line-height:1.7;padding:4px 0">
      Luck boosts apply a <strong style="color:var(--text)">power bias</strong> to every roll while active ‚Äî the stronger the boost,
      the more likely you'll land rare or better. Only one boost can be active at a time.
      Boosts are <strong style="color:var(--text)">not paused</strong> when you close the tab ‚Äî time always counts down.
    </div>
  </div>`;

  body.innerHTML = html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INVENTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setFilter(key) {
  activeFilter = key;
  document.querySelectorAll('.inv-filt').forEach(btn => {
    btn.classList.remove('on'); btn.style.background = '';
    const k = btn.id.replace('filt-','');
    if (k === 'all') { btn.style.color=''; btn.style.borderColor=''; }
    else { const r = RARITIES.find(x=>x.key===k); if(r){ btn.style.color=r.color; btn.style.borderColor=r.color+'44'; }}
  });
  const ab = document.getElementById('filt-'+key);
  if (ab) {
    ab.classList.add('on');
    if (key === 'all') { ab.style.background='var(--muted)'; ab.style.borderColor='var(--muted)'; ab.style.color='#07090f'; }
    else { const r=RARITIES.find(x=>x.key===key); ab.style.background=r.color; ab.style.borderColor=r.color; ab.style.color='#07090f'; }
  }
  renderInv();
}

function renderInv() {
  const grid = document.getElementById('invGrid'), sum = document.getElementById('invSum');
  let items = Object.entries(S.inventory).map(([k,v]) => ({k,...v}));
  if (activeFilter !== 'all') items = items.filter(i => i.rarity.key === activeFilter);
  const sort = document.getElementById('invSort').value;
  if (sort==='rarity-desc') items.sort((a,b)=>ORDER.indexOf(b.rarity.key)-ORDER.indexOf(a.rarity.key));
  else if(sort==='rarity-asc') items.sort((a,b)=>ORDER.indexOf(a.rarity.key)-ORDER.indexOf(b.rarity.key));
  else if(sort==='count-desc') items.sort((a,b)=>b.count-a.count);
  else if(sort==='az') items.sort((a,b)=>a.name.localeCompare(b.name));
  const total = Object.values(S.inventory).reduce((s,v)=>s+v.count,0);
  const unique = Object.keys(S.inventory).length;
  const possible = Object.values(ITEMS).flat().length;
  const chips = RARITIES.filter(r=>S.counts[r.key]>0)
    .map(r=>`<span style="display:flex;align-items:center;gap:4px"><span class="i-dot" style="background:${r.color}"></span>${Object.values(S.inventory).filter(i=>i.rarity.key===r.key).length}</span>`).join('');
  sum.innerHTML = `<span style="color:var(--text);font-weight:700">${unique}/${possible} unique</span><span style="color:var(--muted)">¬∑</span><span>${total} total</span>${chips?`<span style="color:var(--muted)">¬∑</span>${chips}`:''}`;
  grid.innerHTML = '';
  if (!items.length) {
    grid.innerHTML = `<div class="inv-empty"><div class="inv-empty-icon">${activeFilter==='all'?'üéí':'üîç'}</div><div class="inv-empty-txt">${activeFilter==='all'?'Start rolling!':'No '+RARITIES.find(r=>r.key===activeFilter)?.label+' yet'}</div></div>`;
    return;
  }
  items.forEach(({k,emoji,isImage,name,rarity,count}) => {
    const isNew = newItems.has(k) && count === 1;
    const div = document.createElement('div'); div.className = 'inv-item';
    div.style.boxShadow = `0 0 0 1px ${rarity.color}25`; div.onclick = () => openDet(k);
    const emojiHtml = isImage ? `<img src="${emoji}" style="width:48px;height:48px;border-radius:6px">` : emoji;
    div.innerHTML = `<div class="inv-item-bar" style="background:${rarity.color};box-shadow:0 0 6px ${rarity.color}66"></div>
      <div class="inv-item-body"><div class="inv-em">${emojiHtml}</div><div class="inv-iname">${name}</div>
      <div class="inv-itar" style="color:${rarity.color}">${rarity.label}</div></div>
      <div class="inv-cnt">√ó${count}</div>${isNew?'<div class="inv-new">NEW</div>':''}`;
    grid.appendChild(div);
  });
}

function openDet(iKey) {
  const item = S.inventory[iKey]; if(!item) return;
  const {emoji,isImage,name,rarity,count,firstRollNum} = item;
  const emojiHtml = isImage ? `<img src="${emoji}" style="width:80px;height:80px;border-radius:8px">` : emoji;
  document.getElementById('detCard').innerHTML = `
    <div class="det-bar" style="background:${rarity.color};box-shadow:0 0 12px ${rarity.color}99"></div>
    <button class="det-close" onclick="document.getElementById('detOv').classList.remove('open')">‚úï</button>
    <div class="det-body">
      <div class="det-icon" style="filter:drop-shadow(0 0 16px ${rarity.color})">${emojiHtml}</div>
      <div class="det-rar" style="color:${rarity.color}">${rarity.label}</div>
      <div class="det-name" style="color:${rarity.color}">${name}</div>
      <div class="det-sep" style="background:${rarity.color}"></div>
      <div class="det-stats">
        <div class="det-stat"><span class="det-sk">Owned</span><span class="det-sv" style="color:${rarity.color}">√ó${count}</span></div>
        <div class="det-stat"><span class="det-sk">Odds</span><span class="det-sv" style="color:${rarity.color}">${fmtOdds(rarity)}</span></div>
        <div class="det-stat"><span class="det-sk">1st Roll</span><span class="det-sv" style="color:${rarity.color}">#${firstRollNum}</span></div>
      </div>
    </div>
    <div class="det-ring" style="box-shadow:inset 0 0 0 1px ${rarity.color}44,0 0 26px ${rarity.color}30"></div>`;
  document.getElementById('detOv').classList.add('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIGN IN FLOW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function startSignIn() {
  // Check if running on file:// protocol
  if (window.location.protocol === 'file:') {
    notify('Cannot sign in when opened as a file. See instructions below.', 'err');
    console.error('‚ùå Firebase Auth requires HTTP/HTTPS protocol');
    console.log('');
    console.log('üîß HOW TO FIX:');
    console.log('');
    console.log('Option 1 - Python (Easiest):');
    console.log('  1. Open terminal/command prompt in the folder with your HTML file');
    console.log('  2. Run: python -m http.server 8000');
    console.log('  3. Open: http://localhost:8000/REAL_game-fixed.html');
    console.log('');
    console.log('Option 2 - Node.js:');
    console.log('  1. Install: npm install -g http-server');
    console.log('  2. Run: http-server');
    console.log('  3. Open: http://localhost:8080/REAL_game-fixed.html');
    console.log('');
    console.log('Option 3 - VS Code:');
    console.log('  1. Install "Live Server" extension');
    console.log('  2. Right-click HTML file ‚Üí "Open with Live Server"');
    console.log('');
    console.log('Option 4 - Deploy to GitHub Pages (Best for sharing):');
    console.log('  1. Upload to GitHub');
    console.log('  2. Enable Pages in settings');
    console.log('  3. Your game gets a public URL!');
    console.log('');
    
    // Skip to username
    document.getElementById('signInStep').style.display = 'none';
    document.getElementById('usernameStep').style.display = 'block';
    document.getElementById('signedInEmail').parentElement.style.display = 'none';
    setTimeout(() => document.getElementById('unInput').focus(), 100);
    return;
  }
  
  if (!FIREBASE_READY || !auth) {
    // Firebase not configured - skip sign-in and go to username
    console.warn('Firebase not configured. Continuing without authentication.');
    document.getElementById('signInStep').style.display = 'none';
    document.getElementById('usernameStep').style.display = 'block';
    document.getElementById('signedInEmail').parentElement.style.display = 'none';
    setTimeout(() => document.getElementById('unInput').focus(), 100);
    return;
  }
  
  try {
    const provider = new firebase.auth.GoogleAuthProvider();
    const result = await auth.signInWithPopup(provider);
    
    // Sign-in successful - show username step
    document.getElementById('signInStep').style.display = 'none';
    document.getElementById('usernameStep').style.display = 'block';
    document.getElementById('signedInEmail').textContent = result.user.email;
    setTimeout(() => document.getElementById('unInput').focus(), 100);
    
    notify('Signed in successfully!', 'ok');
  } catch (error) {
    console.error('Sign-in error:', error);
    if (error.code === 'auth/popup-closed-by-user') {
      notify('Sign-in cancelled. You can try again or sign in later from the top-right.', 'info');
      // Allow them to skip and enter username
      document.getElementById('signInStep').style.display = 'none';
      document.getElementById('usernameStep').style.display = 'block';
      document.getElementById('signedInEmail').parentElement.style.display = 'none';
      setTimeout(() => document.getElementById('unInput').focus(), 100);
    } else if (error.code === 'auth/popup-blocked') {
      notify('Popup blocked. Please allow popups, or sign in later from top-right.', 'err');
      // Allow them to skip
      document.getElementById('signInStep').style.display = 'none';
      document.getElementById('usernameStep').style.display = 'block';
      document.getElementById('signedInEmail').parentElement.style.display = 'none';
      setTimeout(() => document.getElementById('unInput').focus(), 100);
    } else {
      notify('Sign-in failed. You can try again or sign in later from the top-right.', 'err');
      // Allow them to skip
      document.getElementById('signInStep').style.display = 'none';
      document.getElementById('usernameStep').style.display = 'block';
      document.getElementById('signedInEmail').parentElement.style.display = 'none';
      setTimeout(() => document.getElementById('unInput').focus(), 100);
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function signInWithGoogle() {
  // Check if running on file:// protocol
  if (window.location.protocol === 'file:') {
    notify('Cannot sign in when opened as a file. Check console for instructions.', 'err');
    console.error('‚ùå Firebase Auth requires HTTP/HTTPS protocol');
    console.log('');
    console.log('üîß QUICK FIX - Run a local web server:');
    console.log('');
    console.log('Python (easiest):');
    console.log('  python -m http.server 8000');
    console.log('  Then open: http://localhost:8000/REAL_game-fixed.html');
    console.log('');
    console.log('Or deploy to GitHub Pages for a public URL!');
    return;
  }
  
  if (!FIREBASE_READY || !auth) {
    notify('Firebase not configured. See setup instructions.', 'err');
    console.log('üìö To set up Firebase:');
    console.log('1. Go to https://console.firebase.google.com/');
    console.log('2. Create a project and enable Realtime Database');
    console.log('3. Enable Google Authentication');
    console.log('4. Add your config to the game file');
    return;
  }
  
  try {
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
    notify('Signed in successfully!', 'ok');
  } catch (error) {
    console.error('Sign-in error:', error);
    if (error.code === 'auth/popup-closed-by-user') {
      notify('Sign-in cancelled', 'info');
    } else if (error.code === 'auth/popup-blocked') {
      notify('Popup blocked. Please allow popups for this site.', 'err');
    } else {
      notify('Sign-in failed. Check console for details.', 'err');
    }
  }
}

async function openAdmin() {
  if (!FIREBASE_READY || !auth) {
    notify('Firebase Auth not configured', 'err');
    return;
  }
  
  // If not signed in, sign in with Google
  if (!currentUserEmail) {
    try {
      const provider = new firebase.auth.GoogleAuthProvider();
      await auth.signInWithPopup(provider);
      // Auth state listener will handle the rest
    } catch (error) {
      console.error('Sign-in error:', error);
      if (error.code === 'auth/popup-closed-by-user') {
        notify('Sign-in cancelled', 'info');
      } else {
        notify('Sign-in failed', 'err');
      }
      return;
    }
  }
  
  // Check if user is admin
  if (!isAdmin) {
    notify('Access denied - not an admin', 'err');
    return;
  }
  
  // Show admin panel
  renderAdmin();
  document.getElementById('adminEmail').textContent = currentUserEmail;
  openModal('adminMod');
}

async function signOutAdmin() {
  try {
    await auth.signOut();
    closeModal('adminMod');
    notify('Signed out', 'info');
  } catch (error) {
    console.error('Sign-out error:', error);
    notify('Sign-out failed', 'err');
  }
}

async function renderAdmin() {
  const body = document.getElementById('adminBody');
  const bestR = S.bestIdx >= 0 ? RARITIES.find(r=>r.key===ORDER[S.bestIdx])?.label||'None' : 'None';
  body.innerHTML = `
    <div class="adm-grid">
      <div class="adm-stat"><div class="adm-sl">Rolls</div><div class="adm-sv">${S.total.toLocaleString()}</div></div>
      <div class="adm-stat"><div class="adm-sl">Coins</div><div class="adm-sv" style="color:#fbbf24">ü™ô ${S.coins.toLocaleString()}</div></div>
      <div class="adm-stat"><div class="adm-sl">Best Pull</div><div class="adm-sv" style="color:${RARITIES.find(r=>r.label===bestR)?.color||'var(--text)'}">${bestR}</div></div>
      <div class="adm-stat"><div class="adm-sl">Upgrades</div><div class="adm-sv">${S.upgrades.length}</div></div>
    </div>

    <div class="adm-sec">üí∞ Give Coins</div>
    <div class="m-row">
      <input class="m-inp" id="admCoins" placeholder="Amount..." type="number" style="margin-bottom:0"/>
      <button class="m-btn" style="width:auto;padding:8px 13px;margin-bottom:0" onclick="admGiveCoins()">Give</button>
    </div>

    <div class="adm-sec">üé≤ Force Roll</div>
    <div class="m-row">
      <select class="m-inp" id="admRar" style="margin-bottom:0">
        ${RARITIES.map(r=>`<option value="${r.key}">${r.emoji} ${r.label}</option>`).join('')}
      </select>
      <button class="m-btn" style="width:auto;padding:8px 13px;margin-bottom:0" onclick="admForce()">Force</button>
    </div>

    <div class="adm-sec">üìä Set Roll Count <small style="color:var(--muted);font-family:'Rajdhani'">(cosmetic)</small></div>
    <div class="m-row">
      <input class="m-inp" id="admRollCount" type="number" value="${S.total}" style="margin-bottom:0"/>
      <button class="m-btn" style="width:auto;padding:8px 13px;margin-bottom:0" onclick="admSetRolls()">Set</button>
    </div>

    <div class="adm-sec">‚ö° Turbo Batch Roll <small style="color:var(--muted);font-family:'Rajdhani'">(silent, no animations)</small></div>
    <div class="m-row">
      <input class="m-inp" id="admTurboN" placeholder="Number of rolls..." type="number" style="margin-bottom:0"/>
      <button class="m-btn" style="width:auto;padding:8px 13px;margin-bottom:0;background:linear-gradient(135deg,#e879f9,#818cf8)" onclick="admTurbo()">RUN</button>
    </div>
    <div id="admTurboProg" style="margin-top:5px;display:none">
      <div style="height:3px;background:rgba(255,255,255,.06);border-radius:2px">
        <div id="admTurboBar" style="height:100%;background:linear-gradient(90deg,#e879f9,#818cf8);border-radius:2px;width:0%;transition:width .1s"></div>
      </div>
      <div id="admTurboTxt" style="font-size:.62rem;color:var(--muted);margin-top:4px;text-align:center"></div>
    </div>

    <div class="adm-sec">‚ú® Custom Rarities <small style="color:var(--muted);font-family:'Rajdhani'">(create your own!)</small></div>
    <button class="m-btn" style="background:linear-gradient(135deg,#c084fc,#a78bfa)" onclick="openRarityCreator()">+ CREATE NEW RARITY</button>
    <div id="customRaritiesList" style="margin-top:10px"></div>

    <div class="adm-sec">üèÜ Board Players</div>
    <div id="admPlayers"><div style="color:var(--muted);font-size:.7rem">Loading...</div></div>`;

  // Render custom rarities list
  renderCustomRaritiesList();

  // Load leaderboard players if using Firebase
  if (!FIREBASE_READY || !database) {
    document.getElementById('admPlayers').innerHTML = '<div style="color:var(--muted);font-size:.7rem">Firebase not configured.</div>';
    return;
  }

  try {
    const snapshot = await database.ref('leaderboard').once('value');
    const data = snapshot.val();
    const el = document.getElementById('admPlayers');
    
    if (!data) { 
      el.innerHTML = '<div style="color:var(--muted);font-size:.7rem">No players yet.</div>'; 
      return; 
    }
    
    el.innerHTML = '';
    const entries = Object.entries(data).sort((a, b) => b[1].coins - a[1].coins);
    
    for (const [key, player] of entries) {
      const row = document.createElement('div'); 
      row.className = 'adm-row';
      row.innerHTML = `<span class="adm-name">${esc(player.name||'?')}</span>
        <span class="adm-coins">ü™ô ${(player.coins||0).toLocaleString()}</span>
        <span style="color:var(--muted);font-size:.62rem">${player.rolls||0} rolls</span>
        <button class="adm-del" onclick="admDelPlayer('${key}')">DEL</button>`;
      el.appendChild(row);
    }
  } catch(e) { 
    document.getElementById('admPlayers').innerHTML = '<div style="color:var(--muted);font-size:.7rem">Error loading players.</div>'; 
  }
}

function admGiveCoins() {
  const n = parseInt(document.getElementById('admCoins').value);
  if (isNaN(n) || n <= 0 || n > 100000000) { notify('Invalid amount (1 ‚Äì 100,000,000)','err'); return; }
  S.coins += n; updateUI(); renderAdmin(); notify(`+${n.toLocaleString()} coins`,'ok');
}

function admForce() {
  const key = document.getElementById('admRar').value;
  
  // Get rarity from RARITIES array (works for both built-in and custom)
  const r = RARITIES.find(x => x.key === key);
  if (!r) {
    notify('Rarity not found', 'err');
    return;
  }
  
  // Check if this rarity has items
  if (!ITEMS[r.key] || ITEMS[r.key].length === 0) {
    notify(`No items available for ${r.label}`, 'err');
    return;
  }
  
  // Pick random item from this rarity
  const [emoji, name] = ITEMS[r.key][Math.floor(Math.random() * ITEMS[r.key].length)];
  
  // Update stats
  S.total++;
  if (!S.counts[r.key]) S.counts[r.key] = 0;
  S.counts[r.key]++;
  
  const earned = COIN_REWARDS[r.key] || 10; // Default to 10 coins if not defined
  S.coins += earned;
  
  const ri = ORDER.indexOf(r.key);
  if (ri > S.bestIdx) S.bestIdx = ri;
  
  // Add to inventory
  const isImage = emoji.startsWith('data:image');
  const iKey = `${emoji}|${name}|${r.key}`;
  if (!S.inventory[iKey]) {
    S.inventory[iKey] = {
      emoji: emoji,
      isImage: isImage,
      name: name,
      rarity: r,
      count: 0,
      firstRollNum: S.total
    };
    newItems.add(iKey);
  }
  S.inventory[iKey].count++;
  
  updateUI();
  addHist(r, emoji, name, earned);
  if (currentTab === 'inv') renderInv();
  renderAdmin();
  notify(`Forced ${r.emoji} ${r.label}: ${name}!`, 'ok');
}

function admSetRolls() {
  const n = parseInt(document.getElementById('admRollCount').value);
  if (isNaN(n)||n<0) { notify('Invalid','err'); return; }
  S.total = n; updateUI(); notify(`Roll count set to ${n.toLocaleString()}`,'info');
}

function admTurbo() {
  const n = parseInt(document.getElementById('admTurboN').value);
  if (isNaN(n)||n<1||n>100000000000) { notify('Enter 1‚Äì100000000000','err'); return; }
  closeModal('adminMod');
  let i = 0;
  const batch = 500;
  function run() {
    const end = Math.min(i+batch, n);
    for (; i<end; i++) {
      const r = getRarity(Math.random());
      const [em,nm] = ITEMS[r.key][Math.floor(Math.random()*ITEMS[r.key].length)];
      S.total++; S.counts[r.key]++;
      const earned = COIN_REWARDS[r.key]||1; S.coins += earned;
      const ri=ORDER.indexOf(r.key); if(ri>S.bestIdx) S.bestIdx=ri;
      const ik=`${em}|${nm}|${r.key}`;
      if(!S.inventory[ik]){ S.inventory[ik]={emoji:em,name:nm,rarity:r,count:0,firstRollNum:S.total}; newItems.add(ik); }
      S.inventory[ik].count++;
    }
    updateUI();
    notify(`Turbo: ${i.toLocaleString()} / ${n.toLocaleString()}`, 'info');
    if (i < n) setTimeout(run, 5);
    else { notify(`Turbo done! ${n.toLocaleString()} rolls`, 'ok'); saveGame(false); }
  }
  run();
}

async function admDelPlayer(key) {
  if (!confirm('Delete this player from leaderboard?')) return;
  try { 
    await database.ref('leaderboard/' + key).remove();
    renderAdmin(); 
    notify('Removed','info'); 
  }
  catch(e) { 
    notify('Failed to delete','err'); 
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CUSTOM RARITY CREATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentRarityImage = null;

function openRarityCreator() {
  // Reset form
  document.getElementById('rarName').value = '';
  document.getElementById('rarIcon').value = '';
  document.getElementById('rarColor').value = '#c084fc';
  document.getElementById('rarColorPicker').value = '#c084fc';
  document.getElementById('rarPct').value = '';
  document.getElementById('rarCoins').value = '';
  document.getElementById('rarIconPreview').style.display = 'none';
  document.getElementById('rarErr').style.display = 'none';
  currentRarityImage = null;
  
  // Set up live preview
  ['rarName', 'rarIcon', 'rarColor', 'rarPct', 'rarCoins'].forEach(id => {
    document.getElementById(id).addEventListener('input', updateRarityPreview);
  });
  document.getElementById('rarColorPicker').addEventListener('input', () => {
    document.getElementById('rarColor').value = document.getElementById('rarColorPicker').value;
    updateRarityPreview();
  });
  
  updateRarityPreview();
  openModal('rarityCreatorMod');
}

function updateRarityPreview() {
  const name = document.getElementById('rarName').value || 'NEW RARITY';
  const icon = document.getElementById('rarIcon').value || '‚ú®';
  const color = document.getElementById('rarColor').value || '#c084fc';
  const pct = document.getElementById('rarPct').value || '0.05';
  const coins = document.getElementById('rarCoins').value || '5000';
  
  document.getElementById('rarPreviewName').textContent = name.toUpperCase();
  document.getElementById('rarPreviewName').style.color = color;
  document.getElementById('rarPreviewIcon').textContent = icon;
  document.getElementById('rarPreviewPct').textContent = pct + '%';
  document.getElementById('rarPreviewCoins').textContent = 'ü™ô ' + parseInt(coins || 0).toLocaleString();
}

function handleRarityImage(input) {
  if (input.files && input.files[0]) {
    const file = input.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
      currentRarityImage = e.target.result;
      document.getElementById('rarIconImg').src = currentRarityImage;
      document.getElementById('rarIconPreview').style.display = 'block';
      document.getElementById('rarIcon').value = '[Image]';
      document.getElementById('rarPreviewIcon').innerHTML = `<img src="${currentRarityImage}" style="width:32px;height:32px;border-radius:4px">`;
    };
    reader.readAsDataURL(file);
  }
}

function saveCustomRarity() {
  const name = document.getElementById('rarName').value.trim();
  const icon = document.getElementById('rarIcon').value.trim();
  const color = document.getElementById('rarColor').value.trim();
  const pct = parseFloat(document.getElementById('rarPct').value);
  const coins = parseInt(document.getElementById('rarCoins').value);
  const err = document.getElementById('rarErr');
  
  // Validation
  if (!name) {
    err.textContent = 'Please enter a rarity name';
    err.style.display = 'block';
    return;
  }
  if (!icon && !currentRarityImage) {
    err.textContent = 'Please enter an emoji or upload an image';
    err.style.display = 'block';
    return;
  }
  if (!color || !color.startsWith('#')) {
    err.textContent = 'Please enter a valid hex color (e.g. #ff6b9d)';
    err.style.display = 'block';
    return;
  }
  if (isNaN(pct) || pct <= 0) {
    err.textContent = 'Please enter a valid drop rate';
    err.style.display = 'block';
    return;
  }
  if (isNaN(coins) || coins < 1) {
    err.textContent = 'Please enter a valid coin reward';
    err.style.display = 'block';
    return;
  }
  
  // Sanitise before saving ‚Äî strip HTML tags from name, validate color format
  const safeCRName = name.replace(/[<>&"'`]/g, '').trim().slice(0, 20);
  const safeCRColor = /^#[0-9a-fA-F]{6}$/.test(color) ? color : '#c084fc';
  const safeCRPct = Math.max(0.0001, Math.min(parseFloat(pct), 100));
  const safeCRCoins = Math.max(1, Math.min(parseInt(coins), 999999999));

  // Create custom rarity
  const customRarity = {
    id: 'custom_' + Date.now(),
    name: safeCRName,
    icon: currentRarityImage || icon,
    isImage: !!currentRarityImage,
    color: safeCRColor,
    pct: safeCRPct,
    coins: safeCRCoins,
    created: Date.now()
  };
  
  if (!S.customRarities) S.customRarities = [];
  S.customRarities.push(customRarity);
  saveGame(false);
  
  closeModal('rarityCreatorMod');
  renderAdmin();
  notify(`Created "${name}" rarity!`, 'ok');
}

function renderCustomRaritiesList() {
  const list = document.getElementById('customRaritiesList');
  if (!list) return;
  
  if (!S.customRarities || S.customRarities.length === 0) {
    list.innerHTML = '<div style="color:var(--muted);font-size:.7rem;margin-top:8px">No custom rarities yet. Create one!</div>';
    return;
  }
  
  list.innerHTML = S.customRarities.map((r, i) => {
    const iconHtml = r.isImage 
      ? `<img src="${r.icon}" style="width:24px;height:24px;border-radius:3px">` 
      : r.icon;
    return `
      <div style="display:flex;align-items:center;gap:10px;padding:8px;background:var(--panel2);border-radius:6px;margin-bottom:6px;border:1px solid var(--border)">
        <span style="font-size:1.5rem">${iconHtml}</span>
        <div style="flex:1">
          <div style="font-weight:700;font-size:.8rem;color:${r.color}">${r.name}</div>
          <div style="font-size:.65rem;color:var(--muted)">${r.pct}% ¬∑ ü™ô ${r.coins.toLocaleString()}</div>
        </div>
        <button class="adm-del" onclick="deleteCustomRarity(${i})">DEL</button>
      </div>
    `;
  }).join('');
}

function deleteCustomRarity(index) {
  if (!confirm('Delete this custom rarity?')) return;
  S.customRarities.splice(index, 1);
  saveGame(false);
  renderAdmin();
  notify('Deleted', 'info');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI / HISTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateUI() {
  document.getElementById('hs-name').textContent = S.playerName || '‚Äî';
  document.getElementById('hs-rolls').textContent = S.total.toLocaleString();
  document.getElementById('hs-coins').textContent = S.coins.toLocaleString();
  document.getElementById('shopCoins').textContent = S.coins.toLocaleString();
  document.getElementById('invBadge').textContent = Object.keys(S.inventory).length;
  RARITIES.forEach(r => {
    const el = document.getElementById('cnt-'+r.key);
    if (el) { el.textContent=S.counts[r.key]||0; if((S.counts[r.key]||0)>0) el.style.color=r.color; }
  });
  if (S.bestIdx >= 0) {
    const best = RARITIES.find(x=>x.key===ORDER[S.bestIdx]);
    if (best) { const el=document.getElementById('hs-best'); el.textContent=best.label; el.style.color=best.color; }
  }
  updateBoostUI();
  
  // Turbo unlock at 500 rolls
  const turboOption = document.getElementById('turboOption');
  if (turboOption) {
    const unlocked = S.total >= 500;
    turboOption.disabled = !unlocked;
    if (unlocked) {
      turboOption.textContent = '‚ö° Turbo';
    } else {
      turboOption.textContent = `‚ö° Turbo (üîí ${S.total}/500)`;
    }
  }
  
  // Bg indicator
  const bgOn = autoInt && currentTab !== 'roll';
  document.getElementById('bgIndicator').classList.toggle('on', !!bgOn);
  document.getElementById('bgBadge').classList.toggle('on', !!bgOn);
}

function addHist(r, emoji, name, earned) {
  const list = document.getElementById('histList');
  const item = document.createElement('div'); item.className = 'hist-item';
  item.innerHTML = `<span class="hi-em">${emoji}</span><span class="hi-name">${name}</span><span class="hi-tag" style="color:${r.color}">${r.label}</span>`;
  list.insertBefore(item, list.firstChild);
  while (list.children.length > 80) list.removeChild(list.lastChild);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTO ROLL & TURBO ‚Äî PERSISTS ACROSS TAB SWITCHES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateAutoBtn() {
  const btn = document.getElementById('autoBtn');
  const prog = document.getElementById('progWrap');
  const running = !!autoInt;
  btn.classList.toggle('active', !!autoInt);
  prog.classList.toggle('vis', running);
  if (autoInt) btn.innerHTML = '‚óº STOP <span style="opacity:.4;font-size:.75em">[A]</span>';
  else btn.innerHTML = '‚ü≥ AUTO <span style="opacity:.4;font-size:.75em">[A]</span>';
  updateUI();
}

function animProg(ms) {
  const f = document.getElementById('progFill');
  f.style.transition='none'; f.style.width='0%'; void f.offsetWidth;
  f.style.transition=`width ${ms}ms linear`; f.style.width='100%';
}

function stopAuto() {
  if (autoInt) { clearInterval(autoInt); autoInt=null; }
  updateAutoBtn();
}

function toggleAuto() {
  if (autoInt) { stopAuto(); return; }
  const ms = parseInt(document.getElementById('speedSel').value);
  
  // Check if turbo is selected but not unlocked
  if (ms === 80 && S.total < 500) {
    notify(`‚ö° Turbo unlocks at 500 rolls (${S.total}/500)`, 'warn');
    // Reset dropdown to Fast
    document.getElementById('speedSel').value = '480';
    return;
  }
  
  const go = () => { if (!rolling && !cinematicActive) { doRoll(); if(currentTab==='roll') animProg(ms); } };
  go();
  autoInt = setInterval(go, ms);
  updateAutoBtn();
}

document.getElementById('speedSel').addEventListener('change', () => {
  if (autoInt) { stopAuto(); toggleAuto(); }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-view').forEach(v=>v.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  document.getElementById('view-'+tab).classList.add('active');
  if (tab==='inv') { renderInv(); setTimeout(()=>{ newItems.clear(); renderInv(); },2000); }
  if (tab==='shop') renderShop();
  if (tab==='board') loadBoard(false);
  if (tab==='editor') { renderEditorRarities(); renderEditorItems(); }
  updateUI(); // refresh bg indicator
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODALS / NOTIFY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

let _nTimer = null;
function notify(msg, type='info') {
  const el = document.getElementById('notif');
  el.textContent=msg; el.className='notif '+type;
  void el.offsetWidth; el.classList.add('show');
  if(_nTimer) clearTimeout(_nTimer);
  _nTimer = setTimeout(()=>el.classList.remove('show'), 2800);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KEYBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('keydown', e => {
  const inGame = document.getElementById('un-screen').style.display === 'none';
  if (!inGame) {
    if (e.key === 'Enter') startGame();
    return;
  }
  if (e.key === ' ' && !autoInt && !cinematicActive) { e.preventDefault(); doRoll(); }
  if ((e.key==='a'||e.key==='A') && !cinematicActive) { e.preventDefault(); toggleAuto(); }
  if (e.key==='i'||e.key==='I') { e.preventDefault(); switchTab(currentTab==='inv'?'roll':'inv'); }
  if (e.key==='Escape') {
    document.getElementById('detOv').classList.remove('open');
    document.querySelectorAll('.modal-ov').forEach(m=>m.classList.remove('open'));
    if (cinematicActive) skipCin();
  }
  if ((e.ctrlKey||e.metaKey) && e.key==='s') { e.preventDefault(); saveGame(); }
});

// Ensure auto-roll continues even when tab is in background
document.addEventListener('visibilitychange', () => {
  // Don't stop auto-roll when tab becomes hidden - let it continue
  // This ensures continuous rolling even when user switches tabs
  if (document.hidden) {
    console.log('Tab hidden - auto-roll continues in background');
  } else {
    console.log('Tab visible - auto-roll active');
    // Update UI when returning to tab
    if (gameStarted) updateUI();
  }
});

// Auto-save every 45s, also submit score
setInterval(() => { 
  saveGame(false); 
  if(gameStarted && FIREBASE_READY) submitScore(); 
}, 45000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Initialize Firebase
initFirebase();

// Retry Firebase initialization after a delay if it failed initially
setTimeout(() => {
  if (!FIREBASE_READY && typeof firebase !== 'undefined') {
    console.log('üîÑ Retrying Firebase initialization...');
    initFirebase();
  }
}, 1000);

// Load custom rarities and items first
loadCustomData();

loadGame();
updateUI();
if (S.total > 0) renderInv();
renderShop();
startBoostTick();

// Setup color picker sync
setTimeout(() => {
  const colorInput = document.getElementById('rarityColor');
  const colorPicker = document.getElementById('rarityColorPicker');
  
  if (colorInput && colorPicker) {
    colorInput.addEventListener('input', () => {
      if (colorInput.value.match(/^#[0-9A-Fa-f]{6}$/)) {
        colorPicker.value = colorInput.value;
      }
    });
    
    colorPicker.addEventListener('input', () => {
      colorInput.value = colorPicker.value;
    });
  }
}, 100);

// If returning player (already has name), skip username screen entirely
if (S.playerName && S.playerName.length >= 3) {
  document.getElementById('un-screen').style.display = 'none';
  gameStarted = true;
  updateUI();
  // Load leaderboard with a small delay to ensure Firebase is ready
  setTimeout(() => {
    if (FIREBASE_READY && currentTab === 'board') loadBoard(false);
  }, 500);
} else {
  // New player - check if already signed in
  if (FIREBASE_READY && auth && auth.currentUser) {
    // Already signed in - skip to username step
    document.getElementById('signInStep').style.display = 'none';
    document.getElementById('usernameStep').style.display = 'block';
    document.getElementById('signedInEmail').textContent = auth.currentUser.email;
    setTimeout(() => document.getElementById('unInput').focus(), 100);
  } else {
    // Not signed in - show sign-in step
    setTimeout(() => {
      // If Firebase not ready after 2 seconds, auto-skip to username
      if (!FIREBASE_READY) {
        document.getElementById('signInStep').style.display = 'none';
        document.getElementById('usernameStep').style.display = 'block';
        document.getElementById('signedInEmail').parentElement.style.display = 'none';
        document.getElementById('unInput').focus();
      }
    }, 2000);
  }
}
</script>
</body>
</html>
